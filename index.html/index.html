<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & Press√£o Atmosf√©rica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(135deg,#1565c0,#26c6da);
  color:#fff;
  padding:16px;
}
h2{text-align:center;font-size:24px;}
.card{
  background:rgba(255,255,255,.18);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}
input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-size:16px;
}
button{
  background:#00e676;
  font-weight:bold;
  cursor:pointer;
}
.autocomplete{
  background:#fff;
  color:#000;
  border-radius:10px;
  margin-top:4px;
  overflow:hidden;
}
.autocomplete div{
  padding:10px;
  cursor:pointer;
}
.autocomplete div:hover{background:#e0e0e0;}
.alerta{
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  font-weight:bold;
}
.alerta.verde{background:#2e7d32;}
.alerta.amarelo{background:#f9a825;color:#000;}
.alerta.vermelho{background:#c62828;}
canvas{
  background:#fff;
  border-radius:10px;
  padding:8px;
}

/* FUNDO ANIMADO */
#weather-bg{
  position:fixed;
  inset:0;
  z-index:-1;
  pointer-events:none;
  overflow:hidden;
}
.sun{
  position:absolute;
  top:40px;
  right:40px;
  width:120px;
  height:120px;
  border-radius:50%;
  background:radial-gradient(circle,#fff59d,#fbc02d);
  box-shadow:0 0 60px rgba(255,255,0,.6);
  animation:spin 30s linear infinite;
}
.moon{
  position:absolute;
  top:40px;
  right:40px;
  width:100px;
  height:100px;
  border-radius:50%;
  background:radial-gradient(circle,#f0f0f0,#b0b0b0);
  box-shadow:0 0 30px rgba(255,255,255,.5);
  animation:spin 40s linear infinite;
}
.cloud{
  position:absolute;
  width:220px;
  height:65px;
  background:#fff;
  border-radius:50px;
  opacity:.7;
  animation:cloudMove linear infinite;
}
.cloud::before,.cloud::after{
  content:"";
  position:absolute;
  background:#fff;
  width:90px;
  height:90px;
  border-radius:50%;
  top:-45px;
}
.cloud::before{left:25px}
.cloud::after{left:110px}
.lightning{
  position:absolute;
  top:0;
  width:4px;
  height:100vh;
  background:white;
  opacity:0;
}
.rain{
  position:absolute;
  inset:0;
}
.drop{
  position:absolute;
  bottom:100%;
  width:2px;
  height:20px;
  background:rgba(255,255,255,.6);
  animation:rainFall linear infinite;
}
@keyframes rainFall{0%{:Y(110vh)}}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
@keyframes cloudMove{from{left:-300px}to{left:110%}}
#probChuva{
  display:flex;
  justify-content:flex-start;
  margin-top:10px;
  flex-wrap:nowrap;
  overflow-x:auto;
}
.prob-dia{
  background:rgba(255,255,255,0.18);
  border-radius:10px;
  padding:6px 4px;
  margin-right:4px;
  text-align:center;
  font-weight:bold;
  flex:0 0 auto;
  min-width:50px;
  font-size:12px;
}
.prob-dia .icon{
  font-size:18px;
  display:block;
  margin:2px 0;
}
</style>
</head>
<body>

<div id="weather-bg"></div>

<h2 id="titulo"><span id="icone-clima">üå¶Ô∏è</span> Clima Em:<span id="nome-cidade"></span></h2>

<div class="card">
  <input id="cidade" placeholder="Digite a cidade (ex: Chapec√≥)">
  <div id="lista" class="autocomplete"></div>
  <button onclick="buscar()">Consultar √∫ltimos 7 dias</button>
  <div id="info"></div>
  <div id="historico"></div>
  <div id="previsao"></div>
  <div id="padrao"></div>
  <div id="probChuva"></div>
  <div id="alerta" class="alerta"></div>
</div>

<div class="card">
  <h3>üìä Press√£o atmosf√©rica ‚Äì √∫ltimos 7 dias</h3>
  <canvas id="grafico"></canvas>
</div>

<script>
let lat=null, lon=null, chart=null;
let cidadeEscolhida="";
let chuvaGlobal=[], diasChuvaIndices=[];

const cidade=document.getElementById("cidade");
const lista=document.getElementById("lista");
const info=document.getElementById("info");
const historico=document.getElementById("historico");
const previsao=document.getElementById("previsao");
const padrao=document.getElementById("padrao");
const alerta=document.getElementById("alerta");
const probChuva=document.getElementById("probChuva");
const nomeCidadeSpan = document.getElementById("nome-cidade");
const iconeClimaSpan = document.getElementById("icone-clima");

/* AUTOCOMPLETE */
cidade.addEventListener("input", async ()=>{
  lista.innerHTML="";
  if(cidade.value.length<3) return;
  try{
    const q = encodeURIComponent(cidade.value);
    const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=5&language=pt`);
    if(!r.ok) return;
    const d=await r.json();
    if(!d.results) return;
    d.results.forEach(c=>{
      const div=document.createElement("div");
      div.textContent=c.name+(c.admin1?" - "+c.admin1:"");
      div.onclick=()=>{
        lat=c.latitude;
        lon=c.longitude;
        cidade.value=c.name;
        cidadeEscolhida=c.name + (c.admin1?(" - "+c.admin1):"");
        lista.innerHTML="";
      };
      lista.appendChild(div);
    });
  }catch(err){
    console.error("Erro no autocomplete:", err);
  }
});

/* BUSCAR */
async function buscar(){
  if(!lat){
    alert("Selecione a cidade");
    return;
  }
  const hoje=new Date();
  const inicio=new Date();
  inicio.setDate(hoje.getDate()-7);

  try{
    // Hist√≥rico 7 dias (archive)
    const start = inicio.toISOString().split("T")[0];
    const end = hoje.toISOString().split("T")[0];
    const rHist = await fetch(
      `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&hourly=pressure_msl,precipitation&timezone=America/Sao_Paulo`
    );
    if(!rHist.ok){
      alert("Erro ao obter hist√≥rico.");
      return;
    }
    const dHist = await rHist.json();
    if(!dHist || !dHist.hourly || !Array.isArray(dHist.hourly.time)){
      alert("Hist√≥rico indispon√≠vel para a cidade/intervalo selecionado.");
      return;
    }

    // Forecast
    const rForecast = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=relativehumidity_2m,pressure_msl,precipitation&timezone=America/Sao_Paulo`
    );
    if(!rForecast.ok){
      alert("Erro ao obter previs√£o.");
      return;
    }
    const dForecast = await rForecast.json();
    if(!dForecast || !dForecast.hourly || !Array.isArray(dForecast.hourly.time)){
      alert("Previs√£o hor√°ria indispon√≠vel.");
      return;
    }

    const agora = new Date();
    const agoraMs = agora.getTime();
    // procura √≠ndice mais pr√≥ximo no array de horas
    const diffs = dForecast.hourly.time.map(t => Math.abs(new Date(t).getTime() - agoraMs));
    let safeIdx = 0;
    if(diffs.length>0){
      const min = Math.min(...diffs);
      safeIdx = diffs.indexOf(min);
    }

    const umidadeAtual = (dForecast.hourly.relativehumidity_2m && dForecast.hourly.relativehumidity_2m[safeIdx] != null)
      ? dForecast.hourly.relativehumidity_2m[safeIdx]
      : null;
    const pressaoAtual = (dForecast.hourly.pressure_msl && dForecast.hourly.pressure_msl[safeIdx] != null)
      ? dForecast.hourly.pressure_msl[safeIdx]
      : null;
    const chuvaAtual = (dForecast.hourly.precipitation && dForecast.hourly.precipitation[safeIdx] != null)
      ? dForecast.hourly.precipitation[safeIdx]
      : 0;

    // √≠cone clima e cidade
    let iconeClima="‚òÄÔ∏è";
    if(chuvaAtual>=5) iconeClima="üåßÔ∏è";
    else if(chuvaAtual>=1) iconeClima="‚õÖ";
    iconeClimaSpan.innerText = iconeClima;
    nomeCidadeSpan.innerText = cidadeEscolhida || `${lat.toFixed(2)}, ${lon.toFixed(2)}`;

    // processa hist√≥rico
    processar(dHist, umidadeAtual, pressaoAtual);

    // Previs√£o di√°ria 5 dias (probabilidade)
    const rProb = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=precipitation_probability_max&timezone=America/Sao_Paulo`);
    let dProb = null;
    if(rProb.ok){
      dProb = await rProb.json();
    }

    probChuva.innerHTML="";
    let maxProb=0;
    if(dProb && dProb.daily && Array.isArray(dProb.daily.time)){
      dProb.daily.time.slice(0,5).forEach((dia,i)=>{
        const p=(dProb.daily.precipitation_probability_max && dProb.daily.precipitation_probability_max[i]!=null)
          ? dProb.daily.precipitation_probability_max[i]
          : 0;
        if(p>maxProb) maxProb=p;
        let icone="";
        if(p>=70) icone="üåßÔ∏è";
        else if(p>=40) icone="‚õÖ";
        else icone="‚òÄÔ∏è";
        const div=document.createElement("div");
        div.className="prob-dia";
        div.innerHTML=`<div style="font-size:10px">${dia.split("-").reverse().join("/")}</div><div class="icon">${icone}</div><div style="font-size:10px">${p}%</div>`;
        probChuva.appendChild(div);
      });
    }

    ativarFundo(maxProb);
  }catch(err){
    console.error("Erro na busca:", err);
    alert("Ocorreu um erro ao consultar os dados. Veja o console para mais detalhes.");
  }
}

/* PROCESSAR HIST√ìRICO */
function processar(d, umidadeAtual, pressaoAtual){
  if(!d || !d.hourly || !Array.isArray(d.hourly.time)){
    alert("Dados hist√≥ricos inv√°lidos.");
    return;
  }
  const dias={};
  d.hourly.time.forEach((t,i)=>{
    const dia=t.split("T")[0];
    if(!dias[dia]) dias[dia]={p:[],c:0};
    const pVal = (d.hourly.pressure_msl && d.hourly.pressure_msl[i] != null) ? d.hourly.pressure_msl[i] : null;
    const precipVal = (d.hourly.precipitation && d.hourly.precipitation[i] != null) ? d.hourly.precipitation[i] : 0;
    if(pVal != null) dias[dia].p.push(pVal);
    dias[dia].c += precipVal;
  });
  const labels=[], pressao=[], chuva=[];
  diasChuvaIndices=[];
  const chaves = Object.keys(dias).slice(-7);
  chaves.forEach((dia,i)=>{
    labels.push(dia.split("-").reverse().join("/"));
    const mediaP = (dias[dia].p.length>0) ? (dias[dia].p.reduce((a,b)=>a+b,0)/dias[dia].p.length) : null;
    pressao.push(mediaP);
    chuva.push(dias[dia].c);
    if(dias[dia].c>1) diasChuvaIndices.push(i);
  });
  chuvaGlobal = chuva;
  render(labels, pressao, chuva, umidadeAtual, pressaoAtual);
}

/* RENDER GR√ÅFICO E DADOS */
function render(labels,p,c, umidadeAtual, pressaoAtual){
  const pressaoText = (typeof pressaoAtual === "number" && isFinite(pressaoAtual)) ? `${pressaoAtual.toFixed(1)} hPa` : "‚Äî";
  const umidadeText = (typeof umidadeAtual === "number" && isFinite(umidadeAtual)) ? `${umidadeAtual.toFixed(0)}%` : "‚Äî";
  info.innerHTML=`üå¨Ô∏è Press√£o atual: <b>${pressaoText}</b><br>üíß Umidade atual: <b>${umidadeText}</b>`;
  const validP = p.filter(v=>v!=null && isFinite(v));
  const mediaP = (validP.length>0) ? (validP.reduce((a,b)=>a+b,0)/validP.length).toFixed(1) : "‚Äî";
  historico.innerHTML=`üìä M√©dia 7 dias ‚Äì Press√£o: <b>${mediaP} hPa</b>`;
  let soma=0,cont=0;
  c.forEach((v,i)=>{ if(v>1 && p[i]!=null && isFinite(p[i])){ soma+=p[i]; cont++; }});
  const mediaChuva=cont? (soma/cont) : null;
  previsao.innerHTML=mediaChuva
    ? ( (aoAtual==="number" && pressaoAtual<=mediaChuva) ? "üåßÔ∏è <b>Tend√™ncia de chuva</b>" : "‚òÄÔ∏è <b>Baixa chance de chuva</b>" )
    : "";
  padrao.innerHTML=mediaChuva
    ? `üåßÔ∏è Costuma chover quando a press√£o est√° em torno de <b>${mediaChuva.toFixed(1)} hPa</b>`
    : "";
  alerta.className="alerta";
  const ultimoC = (c.length>0) ? c[c.length - 1] : 0;
  if(ultimoC>20){alerta.classList.add("vermelho");alerta.innerText="üå©Ô∏è ALERTA: Forte tempestade registrada!";}
  else if(ultimoC>5){alerta.classList.add("amarelo");alerta.innerText="‚õàÔ∏è Aten√ß√£o: instabilidade atmosf√©rica";}
  else{alerta.classList.add("verde");alerta.innerText="‚úÖ Sem indicativo de tempestade";}
  if(chart) chart.destroy();

  const datasetP = p.map(v => (v==null ? null : v));
  const pointColors = c.map(v=> v>1 ? "red" : "#1565c0");

  chart=new Chart(document.getElementById("grafico"),{
    type:"line",
    data:{
      labels,
      datasets:[
 datadatasetP,
          borderColor:"#1565c0",
          borderWidth:3,
          tension:.4,
          pointRadius:6,
          pointBackgroundColor:pointColors,
          spanGaps: true
        }
      ]
    },
    options:{responsive:true, scales:{y:{beginAtZero:false}}}
  });
}

/* FUNDO ANIMADO REALISTA */
function ativarFundo(maxProb){
  const bg=document.getElementById("weather-bg");
  bg.innerHTML="";
  const hora=new Date().getHours();
  const noite=(hora<6 || hora>=18);

  if(maxProb>=70){
    // chuva forte
    bg.innerHTML=(noite?'<div class="moon"></div>':'')+
                 criarClouds()+
                 criarLightning()+
                 criarChuva(150,noite);
  }else if(maxProb>=40){
    // nublado
    bg.innerHTML=(noite?'<div class="moon"></div>':'')+
                 criarClouds()+
                 criarChuva(80,noite);
  }else{
    // sol
    bg.innerHTML=noite?'<div class="moon"></div>':'<div class="sun"></div>';
  }
}

function criarClouds(){
  let html="";
  const tops=[100,180,250];
  tops.forEach((t)=>{
    const dur=(120+Math.random()*60).toFixed(0);
    html+=`<div class="cloud" style="top:${t}px;left:-300px;animation-duration:${dur}s;opacity:${0.5+Math.random()*0.3}"></div>`;
  });
  return html;
}
function criarLightning(){
  let html="";
  for(let i=0;i<3;i++){
    const left=(Math.random()*90+5).toFixed(2);
    const delay=(Math.random()*3).toFixed(2);
    html+=`<div class="lightning" style="left:${left}%;animation-delay:${delay}s;"></div>`;
  }
  return html;
}
function criarChuva(qtd,noite){
  let html='<div class="rain">';
  for(let i=0;i<qtd;i++){
    const left=(Math.random()*100).toFixed(2);
    const dur=(Math.random()*1.5+0.7).toFixed(2);
    const delay=(Math.random()*-5).toFixed(2);
    const cor=noite?'rgba(180,180,255,0.6)':'rgba(255,255,255,0.6)';
    const height=(15+Math.random()*10).toFixed(0);
    html+=`<div class="drop" style="left:${left}%;height:${height}px;animation-duration:${dur}s;animation-delay:${delay}s;background:${cor}"></div>`;
  }
  html+='</div>';
  return html;
}
</script>
</body>
</html>