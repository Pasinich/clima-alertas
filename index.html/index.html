<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & Press√£o Atmosf√©rica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* =========================
   VARI√ÅVEIS DE TEMA
========================= */
:root{
 --bg1:#1565c0;
 --bg2:#26c6da;
 --card:rgba(255,255,255,.18);
 --text:#fff;
 --grafico:#fff;
}
body.dark{
 --bg1:#0d1117;
 --bg2:#161b22;
 --card:rgba(255,255,255,.08);
 --text:#e6edf3;
 --grafico:#0d1117;
}

/* =========================
   ESTILO GLOBAL
========================= */
body{
 margin:0;
 font-family:Arial,sans-serif;
 background:linear-gradient(135deg,var(--bg1),var(--bg2));
 color:var(--text);
 padding:14px;
 transition:.3s;
}
header{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:6px;
}
h2{font-size:16px;margin:0;font-weight:normal;}
h2 span{font-weight:bold;}
button.toggle{
 background:rgba(255,255,255,.25);
 border:none;
 border-radius:50px;
 padding:6px;
 font-size:14px;
 cursor:pointer;
 color:var(--text);
}

/* =========================
   CARDS E INPUT
========================= */
.card{
 background:var(--card);
 border-radius:16px;
 padding:16px;
 margin-bottom:1px;
}
input{
 width:100%;
 padding:12px;
 border:none;
 border-radius:10px;
 font-size:14px;
}

/* =========================
   AUTOCOMPLETE
========================= */
.autocomplete{
 background:#fff;
 color:#000;
 border-radius:10px;
 margin-top:4px;
 position:absolute;
 z-index:10;
 width:calc(100% - 32px);
}
.autocomplete div{padding:10px;cursor:pointer;}
.autocomplete div:hover{background:#e0e0e0;}

/* =========================
   LINHAS DE INFORMA√á√ÉO
========================= */
.linha-info{margin-top:6px;font-size:14px;}
.linha-status{margin-top:6px;font-size:13px;font-weight:bold;padding:6px;border-radius:8px;}

.bom{background:#f9a825;color:#000;}
.chuva{background:#f9a825;color:#000;}
.tempestade{background:#f9a825;color:#000;}

/* =========================
   QUALIDADE DO AR
========================= */
.aq-bom{color:#0A3D0A;font-weight:bold;}
.aq-mod{color:#ffeb3b;font-weight:bold;}
.aq-ruim{color:#ff9800;font-weight:bold;}
.aq-muito{color:#f44336;font-weight:bold;}
.aq-severo{color:#f44336;font-weight:bold;}
.aq-extremo{color:#b71c1c;font-weight:bold;}

/* =========================
   CHUVA
========================= */
.chuva-bom{color:#0A3D0A;font-weight:bold;}
.chuva-mod{color:#ffeb3b;font-weight:bold;}
.chuva-ruim{color:#ff9800;font-weight:bold;}
.chuva-muito{color:#f44336;font-weight:bold;}
.chuva-extremo{color:#6a1b9a;}

/* =========================
   SOL
========================= */
#linha-sol{display:flex;gap:8px;margin-top:12px;}
.sol-dia{
 flex:1;
 background:#1a237e;
 border-radius:10px;
 padding:6px;
 height:45px;
 display:flex;
 flex-direction:column;
 justify-content:center;
 align-items:center;
 font-size:10px;
 font-weight:bold;
}
body.dark .sol-dia{background:#0b3c5d;}

/* =========================
   PREVIS√ÉO
========================= */
#previsao-5dias{
 display:flex;
 gap:6px;
 margin-top:4px;
 overflow-x:auto;
 margin-bottom:4px;
}
.previsao-dia{
 background:rgba(255,255,255,.18);
 border-radius:10px;
 padding:6px;
 min-width:80px;
 text-align:center;
 font-size:10px;
 font-weight:bold;
}

/* =========================
   GR√ÅFICOS
========================= */
canvas{
 background:var(--grafico);
 border-radius:10px;
 padding:8px;
 margin-top:1px;
}
</style>
</head>
<body>

<header>
 <h2>üå°Ô∏è Clima em: <span id="nome-cidade"></span></h2>
 <button class="toggle" id="toggleModo">üåô</button>
</header>

<div class="card">
 <input id="cidade" placeholder="Digite a cidade">
 <div id="lista" class="autocomplete"></div>

 <!-- ===== DADOS ATUAIS ===== -->
 <div id="info"></div>
 <div id="linha-pressao" class="linha-info"></div>
 <div id="linha-visibilidade" class="linha-info"></div>
 <div id="linha-vento" class="linha-info"></div>
 <div id="linha-umidade" class="linha-info"></div>
 <div id="linha-nevoeiro" class="linha-info"></div>
 <div id="linha-lua" class="linha-info"></div>
 <div id="linha-status" class="linha-status"></div>
 <div id="linha-aviso" class="linha-info"></div>

 <!-- ===== SOL E PREVIS√ÉO ===== -->
 <div id="linha-sol"></div>
 <div id="previsao-5dias"></div>
</div>

<div class="card">
 <canvas id="graficoPrevisao"></canvas>
</div>

<div class="card">
 <canvas id="grafico"></canvas>
</div>

<div class="card">
  <canvas id="graficoMensal"></canvas>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
<script>

function limparTela(){
  info.innerHTML = "‚è≥ Carregando dados...";
  linhaPressao.innerHTML = "";
  linhaVisibilidade.innerHTML = "";
  linhaVento.innerHTML = "";
  linhaUmidade.innerHTML = "";
  linhaNevoeiro.innerHTML = "";
  linhaLua.innerHTML = "";
  linhaStatus.innerHTML = "";
  linhaAviso.innerHTML = "";
  linhaSol.innerHTML = "";
  previsao5.innerHTML = "";

  // destr√≥i gr√°ficos antigos
  chart?.destroy(); 
  chartPrevisao?.destroy();
  chartMensal?.destroy();

  chart = null;
  chartPrevisao = null;
  chartMensal = null;
}

/* =========================
   VARI√ÅVEIS GLOBAIS
========================= */
let lat=null, lon=null;
let chart=null, chartPrevisao=null;
let histSalvo=null;
let pressaoTexto = "";
let chartMensal = null;
let paisSelecionado = "";
let oni = -0.6;
let estadoSelecionado = null;

async function obterEstadoPorLatLon(lat, lon){
  try{
    const r = await fetch(
      `https://geocoding-api.open-meteo.com/v1/reverse` +
      `?latitude=${lat}&longitude=${lon}&language=pt`
    );
    const d = await r.json();
    return d?.results?.[0]?.admin1 ?? null;
  }catch{
    return null;
  }
}

/* =========================
   ELEMENTOS DOM
========================= */
const cidade=document.getElementById("cidade"),
lista=document.getElementById("lista"),
nomeCidade=document.getElementById("nome-cidade"),
info=document.getElementById("info"),
linhaPressao=document.getElementById("linha-pressao"),
linhaVisibilidade=document.getElementById("linha-visibilidade"),
linhaVento=document.getElementById("linha-vento"),
linhaUmidade=document.getElementById("linha-umidade"),
linhaNevoeiro=document.getElementById("linha-nevoeiro"),
linhaLua=document.getElementById("linha-lua"),
linhaStatus=document.getElementById("linha-status"),
linhaAviso=document.getElementById("linha-aviso"),
linhaSol=document.getElementById("linha-sol"),
previsao5=document.getElementById("previsao-5dias"),
btnModo=document.getElementById("toggleModo");


/* =========================
   Dist√¢ncia das cidades at√© a praia 
========================= */
function distanciaKm(lat1, lon1, lat2, lon2){
  const R = 6371; // raio da Terra em km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI/180) *
    Math.cos(lat2 * Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* =========================
   Pontos GPS litor√¢nea 
========================= */
const pontosLitoralBrasil = [
  // RS
  [-33.3, -53.4], // Torres
  [-31.4, -51.2], // Tramanda√≠
  [-30.0, -50.2], // Cap√£o da Canoa
  [-29.2, -49.7], // Imb√©
  [-29.0, -49.7], // Xangri-l√°
  [-29.0, -50.0], // Os√≥rio
  [-30.3, -50.2], // Palmares do Sul

  // SC
  [-26.7, -48.6], // Barra Velha
  [-26.8, -48.6], // Balne√°rio Pi√ßarras
  [-27.0, -48.6], // Itaja√≠
  [-27.1, -48.6], // Navegantes
  [-27.1, -48.6], // Porto Belo
  [-27.1, -48.6], // Bombinhas
  [-27.6, -48.6], // Balne√°rio Cambori√∫
  [-27.6, -48.6], // Itapema
  [-27.7, -48.5], // Tijucas
  [-27.5, -48.5], // Florian√≥polis
  [-27.6, -48.5], // S√£o Jos√©
  [-28.0, -48.7], // Palho√ßa
  [-28.1, -48.7], // Imbituba
  [-28.5, -49.0], // Garopaba
  [-28.5, -49.0], // Laguna
  [-28.7, -49.0], // Pescaria Brava
  [-28.8, -48.7], // Bombinhas (parte sul)
  [-27.3, -48.5], // Brusque (pr√≥ximo ao litoral)
  
  // PR
  [-25.5, -48.5], // Matinhos
  [-25.6, -48.5], // Caiob√°
  [-25.7, -48.5], // Guaratuba
  [-25.9, -48.6], // Pontal do Paran√°
  [-26.0, -48.5], // Paranagu√°
  [-25.5, -48.7], // Ilha do Mel

  // SP
  [-23.5, -45.4], // Santos
  [-23.9, -45.4], // Guaruj√°
  [-24.0, -45.5], // Bertioga
  [-23.8, -45.5], // Ilhabela
  [-24.6, -46.7], // Ubatuba
  [-23.6, -45.4], // S√£o Sebasti√£o
  [-24.3, -46.6], // Caraguatatuba
  [-24.1, -46.6], // Praia das Toninhas

  // RJ
  [-22.8, -43.2], // Rio de Janeiro
  [-23.0, -43.1], // Niter√≥i
  [-22.6, -41.8], // Arraial do Cabo
  [-22.9, -42.0], // B√∫zios
  [-22.7, -42.0], // Cabo Frio
  [-22.5, -41.7], // S√£o Pedro da Aldeia
  [-22.5, -42.0], // Araruama
  [-22.4, -42.0], // Iguaba Grande
  [-22.3, -42.0], // Saquarema

  // ES
  [-20.3, -40.3], // Vit√≥ria
  [-20.4, -40.3], // Vila Velha
  [-19.0, -40.3], // Guarapari
  [-18.9, -39.9], // Anchieta
  [-19.2, -40.1], // Pi√∫ma
  [-18.8, -39.8], // Itapemirim
  [-18.7, -39.7], // Marata√≠zes

  // BA
  [-17.9, -39.0], // Porto Seguro
  [-16.5, -39.1], // Ilh√©us
  [-14.8, -39.0], // Itacar√©
  [-13.0, -38.5], // Salvador
  [-12.9, -38.5], // Lauro de Freitas
  [-12.6, -38.0], // Praia do Forte
  [-12.5, -38.0], // Imbassa√≠
  [-11.5, -37.5], // Santo Andr√©
  [-11.3, -37.5], // Cumuruxatiba

  // AL
  [-9.0, -35.7], // Macei√≥
  [-9.4, -35.7], // Maragogi
  [-9.3, -35.8], // Japaratinga

  // PE
  [-8.0, -34.9], // Recife
  [-8.1, -34.9], // Olinda
  [-8.4, -35.0], // Porto de Galinhas
  [-7.9, -35.1], // Ipojuca

  // RN
  [-5.8, -35.2], // Natal
  [-5.9, -35.1], // Pipa
  [-5.8, -35.0], // Tibau do Sul

  // CE
  [-3.7, -38.5], // Fortaleza
  [-3.8, -38.5], // Aquiraz
  [-3.5, -38.6], // Canoa Quebrada
  [-3.6, -38.7], // Aracati

  // MA
  [-2.5, -44.3], // S√£o Lu√≠s
  [-2.7, -44.3], // Alc√¢ntara
  [-2.8, -44.2], // Raposa

  // PA
  [-0.7, -48.5], // Bel√©m
  [-0.8, -48.5], // Barcarena
  [-0.9, -48.6], // Maracan√£
];

/* =======================
Cidade possui praia 
========================= */
function cidadePossuiPraia(pais, lat, lon){
  if (pais !== "BR") return false;

  return pontosLitoralBrasil.some(
    ([plLat, plLon]) =>
      distanciaKm(lat, lon, plLat, plLon) <= 70
  );
}

/* =======================
Avalia√ß√£o da praia 
========================= */

function avaliarPraia(temp, probChuva, vento, uv){
  if (temp >= 25 && probChuva < 20 && vento <= 15 && uv <= 8)
    return "üèñÔ∏èBoa";

  if (temp >= 20 && probChuva < 40)
    return "üèñÔ∏èRegular";

  return "üèñÔ∏èN√£o indicada";
}


/* =========================
   MODO DIA / NOITE
========================= */
function aplicarModo(m){
 document.body.classList.toggle("dark", m==="dark");

 btnModo.innerHTML = m==="dark"
  ? "‚òÄÔ∏è<span style='font-size:10px'>Modo Dia</span>"
  : "üåô<span style='font-size:10px'>Modo Noite</span>";

 localStorage.setItem("modo", m);
 if(histSalvo) montarGrafico(histSalvo);
 if(chartPrevisao) chartPrevisao.update();
}

function modoAuto(){
 const h=new Date().getHours();
 const sys=matchMedia("(prefers-color-scheme: dark)").matches;
 return (h>=18 || h<=6 || sys) ? "dark" : "light";
}

aplicarModo(localStorage.getItem("modo") || modoAuto());

btnModo.onclick = () =>
 aplicarModo(document.body.classList.contains("dark") ? "light" : "dark");

/* =========================
   LIMPAR INPUT
========================= */
cidade.addEventListener("focus",()=>{
 cidade.value="";
 lista.innerHTML="";
});
/* =========================
   AUTOCOMPLETE DE CIDADES
========================= */
cidade.addEventListener("input",async()=>{
 lista.innerHTML="";
 if(cidade.value.length < 2) return;

 const r = await fetch(
  `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cidade.value)}&count=10&language=pt`
 );
 const d = await r.json();
 if(!d.results) return;

 d.results.forEach(c=>{
  const local = c.country_code==="BR" && c.admin1
   ? `${c.name} - ${c.admin1}`
   : `${c.name} - ${c.country}`;

  const div = document.createElement("div");
  div.innerText = local;
  div.onclick = ()=>{
  cidade.value = local;
  nomeCidade.innerText = local;
  lat = c.latitude;
  lon = c.longitude;
  paisSelecionado = c.country_code;
  estadoSelecionado = c.admin1 ?? null; 
  lista.innerHTML = "";

  limparTela();
  buscar();
};

  lista.appendChild(div);
 });
});

/* =========================
   ENTER SELECIONA PRIMEIRO
========================= */
cidade.addEventListener("keydown",e=>{
 if(e.key==="Enter"){
  const item = lista.querySelector("div");
  if(item) item.click();
 }
});

/* =========================
   BUSCA PRINCIPAL
========================= */
async function buscar(){
 if(lat===null || lon===null){
  info.innerHTML="üìçSelecione a cidade na lista";
  return;
 }

  /* ===== API ATUAL ===== */
 const rAtual = await fetch(
  `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
  `&current_weather=true` +
  `&hourly=apparent_temperature,relativehumidity_2m,pressure_msl,precipitation,precipitation_probability,visibility,cloudcover,windspeed_10m` +
  `&daily=sunrise,sunset,temperature_2m_min,temperature_2m_max,precipitation_sum,precipitation_probability_max,uv_index_max` +
  `&timezone=auto`
 );
 const atual = await rAtual.json();

 /* ===== API QUALIDADE DO AR ===== */
 const rAQ = await fetch(
  `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5,pm10,european_aqi&timezone=auto`
 );
 const aq = await rAQ.json();

 /* =========================
    √çNDICE HOR√ÅRIO ATUAL
 ========================= */
 const agora = Date.now();
 let idx = 0, min = Infinity;

 atual.hourly.time.forEach((t,i)=>{
  const d = Math.abs(new Date(t).getTime() - agora);
  if(d < min){ min = d; idx = i; }
 });

 let idxAQ = 0, minAQ = Infinity;
 aq.hourly.time.forEach((t,i)=>{
  const d = Math.abs(new Date(t).getTime() - agora);
  if(d < minAQ){ minAQ = d; idxAQ = i; }
 });

/* =========================
   PR√ìXIMA CHUVA
========================= */
let proximaChuva = "‚Äî";
let probChuva = 0;
let idxChuva = -1; // √≠ndice da pr√≥xima chuva

for(let i = idx; i < atual.hourly.time.length; i++){
  const mm = atual.hourly.precipitation?.[i] ?? 0;
  const prob = atual.hourly.precipitation_probability?.[i] ?? 0;

  if(mm > 0 || prob >= 20){
    proximaChuva = atual.hourly.time[i].slice(11,16); // ainda mantemos hora para compatibilidade
    probChuva = prob;
    idxChuva = i; // guarda o √≠ndice
    break;
  }
}

 /* =========================
    UV
 ========================= */
 const uvIndex = atual.daily.uv_index_max?.[0] ?? 0;
 const {classe, descricao} = formatarUV(uvIndex);

 info.innerHTML = `
  <span style="font-size:13px">
   üå°Ô∏è<b>${atual.current_weather.temperature}¬∞C </b>(
   Sensa√ß√£o: ${atual.hourly.apparent_temperature[idx]}¬∞C) 
   ‚Ä¢ ‚òÄÔ∏èUV: <b class="${classe}">${uvIndex}</b> (${descricao})
  </span>`;
  
  /* =========================
   QUALIDADE DO AR (AQI)
========================= */
let usAQI = 0;

if (aq?.hourly?.pm2_5?.length && typeof idxAQ === "number") {
  const pm25 = aq.hourly.pm2_5[idxAQ] ?? 0;
  usAQI = pm25ToUSAQI(pm25);
}
  
/* =========================
   PRESS√ÉO ATMOSF√âRICA (ATUAL REAL)
========================= */
let pressaoExibir = "‚Äî";

// prioridade m√°xima: valor atual real
if (typeof atual?.current_weather?.pressure_msl === "number") {
  pressaoExibir = atual.current_weather.pressure_msl;
}
// fallback apenas se n√£o existir
else if (typeof atual?.hourly?.pressure_msl?.[idx] === "number") {
  pressaoExibir = atual.hourly.pressure_msl[idx];
}
let pressaoExibir_masc = atual.hourly.pressure_msl[idx] + 3.1;

// √çndice do dia
const diaDoIdx = Math.floor(idx / 24);
const horarioOuro = calcularHorarioOuroDoDiaCompacto(
  atual.daily.sunrise[diaDoIdx],
  atual.daily.sunset[diaDoIdx]
);

linhaPressao.innerHTML = `
  üéàPress√£o: <b>${(atual.hourly.pressure_msl[idx] + 3.1).toFixed(1)} hPa</b>
  ${/*pressaoTexto ? ` | <span style="font-size:13px; opacity:0.9">${pressaoTexto}</span>` :*/ ""}
`;
 

 /* =========================
    VISIBILIDADE (VALOR V√ÅLIDO)
 ========================= */
 let vis = null;

 for(let i = idx; i < atual.hourly.visibility.length; i++){
  const v = atual.hourly.visibility[i];
  if(v != null && v <= 30000){ vis = v; break; }
 }
 if(vis === null){
  for(let i = idx-1; i >= 0; i--){
   const v = atual.hourly.visibility[i];
   if(v != null && v <= 30000){ vis = v; break; }
  }
 }

 const visibilidade = vis != null ? (vis/1600).toFixed(2) : "‚Äî";

 /* =========================
    DIRE√á√ÉO DO VENTO
 ========================= */
 const deg = atual.current_weather.winddirection ?? null;

 function degParaDirecao(d){
  if(d==null) return "‚Äî";
  const dirs = [
   "Norte","Norte-Nordeste","Nordeste","Leste-Nordeste",
   "Leste","Leste-Sudeste","Sudeste","Sul-Sudeste",
   "Sul","Sul-Sudoeste","Sudoeste","Oeste-Sudoeste",
   "Oeste","Oeste-Noroeste","Noroeste","Norte-Noroeste"
  ];
  return dirs[Math.round(d/22.5) % 16];
 }

 const direcaoVento = degParaDirecao(deg);

 linhaVisibilidade.innerHTML =
  `üëÅÔ∏èVisibil.:<b>${visibilidade} km</b> ‚Ä¢ ` +
  `üí®Vento:<b>${atual.current_weather.windspeed} km/h</b> ` +
  `(<b>${direcaoVento}</b>)`;

/* =========================
    RAJADAS DE VENTO (ADICIONADO)
 ========================= */
 let rajadas = "‚Äî";
 if(atual.hourly.windspeed_10m?.[idx] != null){
  rajadas = (atual.hourly.windspeed_10m[idx] * 1.6).toFixed(1);
 }

/* =========================
    NEVOEIRO + RAJADAS (CORRIGIDO)
 ========================= */
let nevoeiro = "Ausenteüå§Ô∏è";

// nevoeiro pela visibilidade (em METROS)
if(vis !== null){
  if(vis <= 1000){
    nevoeiro = "Nevoeiro Denso ";
  }
  else if(vis <= 2000){
    nevoeiro = "Nevoeiro Fraco ";
  }
}

// confirma√ß√£o por umidade + vento
const umid = atual.hourly.relativehumidity_2m[idx];
const vento = atual.current_weather.windspeed;

if(vis !== null && umid >= 84 && vento <= 4){
  nevoeiro = "Nevoeiros Esparsos ";
}

linhaNevoeiro.innerHTML =
 `üå´Ô∏è Nevoeiro: <b>${nevoeiro}</b> ‚Ä¢ üå¨Ô∏èRajadas: <b>${rajadas} km/h</b>`;

 /* =========================
    UMIDADE / CHUVA / NEBULOSIDADE
 ========================= */
 const chuvaHora = atual.hourly.precipitation_probability?.[idx] ?? 0;

 let neb = null;
 for(let i = idx; i < atual.hourly.cloudcover.length; i++){
  const v = atual.hourly.cloudcover[i];
  if(v != null && v >= 0 && v <= 100){ neb = v; break; }
 }
 if(neb === null){
  for(let i = idx-1; i >= 0; i--){
   const v = atual.hourly.cloudcover[i];
   if(v != null && v >= 0 && v <= 100){ neb = v; break; }
  }
 }

 const nebulosidade = neb !== null ? neb : "‚Äî";

 linhaUmidade.innerHTML =
  `üíßUmidade:<b>${atual.hourly.relativehumidity_2m[idx]}%</b> ‚Ä¢ ` +
  `üåßÔ∏èChuva:<b class="${formatarChuvaClasse(chuvaHora)}">${chuvaHora}%</b> ‚Ä¢ ` +
  `‚òÅÔ∏èNebulosidade:<b>${nebulosidade}%</b>`;
 
 
 function estacaoDoAno(data = new Date(), lat = -30) {
  const d = data.getDate();
  const m = data.getMonth() + 1;
  const norte = lat >= 0;

  if (norte) {
    // Hemisf√©rio Norte
    if ((m === 12 && d >= 21) || (m <= 3 && (m < 3 || d <= 20))) {
      return "Inverno";
    }
    if ((m === 3 && d >= 21) || (m <= 6 && (m < 6 || d <= 20))) {
      return "Primavera";
    }
    if ((m === 6 && d >= 21) || (m <= 9 && (m < 9 || d <= 22))) {
      return "Ver√£o";
    }
    return "Outono";
  }

  // Hemisf√©rio Sul
  if ((m === 12 && d >= 21) || (m <= 3 && (m < 3 || d <= 20))) {
    return "Ver√£o";
  }
  if ((m === 3 && d >= 21) || (m <= 6 && (m < 6 || d <= 20))) {
    return "Outono";
  }
  if ((m === 6 && d >= 21) || (m <= 9 && (m < 9 || d <= 22))) {
    return "Inverno";
  }
  return "Primavera";
}

// =========================
// FUN√á√ÉO HOR√ÅRIO DE OURO COMPACTA
// =========================
function calcularHorarioOuroDoDiaCompacto(lat, lon, data = new Date()) {
  const t = SunCalc.getTimes(data, lat, lon);
  const pad = n => String(n).padStart(2, "0");

  // Golden hour: 1 hora ap√≥s nascer do sol at√© 1 hora antes do p√¥r do sol
  const inicio = new Date(t.sunrise.getTime() + 0*60*60*1000);
  const fim = new Date(t.sunset.getTime() - 0*60*60*1000);

  return `${pad(inicio.getHours())}:${pad(inicio.getMinutes())} - ${pad(fim.getHours())}:${pad(fim.getMinutes())}`;
}
const fotografia = calcularHorarioOuroDoDiaCompacto(lat, lon, new Date());

/* Montar painel clim√°tico */


montarPainelClimatico({
  atual,
  idx,
  idxChuva,
  probChuva,
  pais: paisSelecionado,   
  estado: estadoSelecionado ,
  cidade: nomeCidade.innerText,
  nebulosidade 
});

async function montarPainelClimatico(
{ atual, idx, idxChuva, probChuva, pais, estado,cidade, nebulosidade }) {
const lat = atual.latitude ?? latitudeSelecionada ?? -30;
const estacao = estacaoDoAno(new Date(), lat);
const lua = calcularLua(new Date());
const iluminacaoLua = Number(lua.iluminacao);

const estrelas = avaliarEstrelas(
  nebulosidade,
  atual.hourly.precipitation_probability[idx],
  iluminacaoLua
);

  // üîπ normaliza√ß√µes
  const siglaEstado = normalizarEstadoParaSigla(estado);


  /* ===== LUA ===== */
  
  linhaLua.innerHTML =
    `üåôLua: <b>${lua.fase}</b> ‚Ä¢ Luar: <b>${lua.iluminacao}%</b> ‚Ä¢ Idade: <b>${lua.idade} dias</b>`;

  /* ===== STATUS BASE (COLORIDO) ===== */
  let statusTexto = "";
  if(atual.hourly.precipitation[idx] > 8 || atual.hourly.pressure_msl[idx] < 1005){
    linhaStatus.className = "linha-status tempestade";
    statusTexto = "‚õàÔ∏èRisco de Tempestade";
  }
  else if(atual.hourly.precipitation[idx] > 1 || atual.hourly.pressure_msl[idx] < 1012){
    linhaStatus.className = "linha-status chuva";
    statusTexto = "üåßÔ∏èPossibilidade de Chuva";
  }
  else{
    linhaStatus.className = "linha-status bom";
    statusTexto = "‚òÄÔ∏èTempo bom";
  }

  /* ===== HORA LOCAL ===== */
  /*const horaAtualCidade = atual.current_weather?.time?.slice(11, 16) ?? "‚Äî";*/
  let dataHoraLocal = "‚Äî";

if (atual.current_weather?.time) {
  const dt = new Date(atual.current_weather.time);

  dataHoraLocal =
    `${String(dt.getDate()).padStart(2, "0")}/` +
    `${String(dt.getMonth() + 1).padStart(2, "0")}/` +
    `${dt.getFullYear()} - ` +
    `${String(dt.getHours()).padStart(2, "0")}:` +
    `${String(dt.getMinutes()).padStart(2, "0")}:` +
    `${String(dt.getSeconds()).padStart(2, "0")}`;
}


  /* ===== CHUVA PREVISTA ===== */
  let chuvaTexto = "";
  if (Number.isInteger(idxChuva) && idxChuva >= 0) {
    const t = new Date(atual.hourly.time[idxChuva]);
    
  // soma 3 hora
     t.setHours(t.getHours() + 3); /* soma 3 horas para ajustar o tempo de chuva*/
    const dataHora =
      `${String(t.getDate()).padStart(2,"0")}/` +
      `${String(t.getMonth()+1).padStart(2,"0")}/` +
      `${t.getFullYear()} - ` +
      `${String(t.getHours()).padStart(2,"0")}:` +
      `${String(t.getMinutes()).padStart(2,"0")} hs`;
      
      chuvaTexto = `<span style="color:#8B008B; font-size:14px;">Prox.Chuva prevista:</span> <b>${dataHora} (${probChuva}%)</b>`;
      
    }

  /* ===== PRESS√ÉO M√âDIA */
  pressaoTexto = "";
  if(histSalvo && histSalvo.time?.length){
    const dias={};
    histSalvo.time.forEach((t,i)=>{
      const d=t.split("T")[0];
      dias[d] ??= {p:[], mm:0};
      dias[d].p.push(histSalvo.pressure_msl[i]);
      dias[d].mm += histSalvo.precipitation[i];
    });
    const press=[];
    Object.values(dias).forEach(d=>{
      if(d.mm>=1) press.push(d.p.reduce((a,b)=>a+b)/d.p.length);
    });
    if(press.length > 0){
      const m = press.reduce((a,b)=>a+b)/press.length;
      pressaoTexto = `üåßÔ∏èCom press√£o m√©dia de <b>${m.toFixed(1)} hPa</b>`;
    } else {
      pressaoTexto = `üåßÔ∏èDados insuficientes para calcular press√£o m√©dia de chuva`;
    }
  } else {
    pressaoTexto = `üåßÔ∏èDados hist√≥ricos n√£o dispon√≠veis`;
  }

  /* ===== FEN√îMENO ONI ===== */
  let fenomeno = "Neutro";
  if (oni >= 0.5) fenomeno = "El Ni√±o";
  else if (oni <= -0.5) fenomeno = "La Ni√±a";

/* ===== AVALIA√á√ïES ===== */
const pesca = avaliarPesca(
  atual.hourly.pressure_msl[idx],
  atual.current_weather.windspeed,
  atual.hourly.precipitation[idx]
);

const churrascoTexto = avaliarChurrasco(
  atual.current_weather.temperature,
  atual.hourly.precipitation_probability[idx],
  atual.hourly.windspeed_10m[idx]
);

const corrida = avaliarCorrida(
  atual.current_weather.temperature,
  atual.hourly.precipitation_probability[idx],
  atual.current_weather.windspeed,
  atual.daily.uv_index_max?.[0] ?? 0
);

const caminhada = avaliarCaminhada(
  atual.current_weather.temperature,
  atual.hourly.precipitation_probability[idx],
  atual.current_weather.windspeed,
  atual.daily.uv_index_max?.[0] ?? 0,
  vis
);

// üö¥ Ciclismo 
const ciclismo = avaliaCiclismo(
  atual.hourly.precipitation_probability[idx],
  atual.current_weather.windspeed,
  atual.hourly.pressure_msl[idx]
);

const aviao = avaliarAviao(
  atual.current_weather.windspeed,
  vis,
  atual.hourly.precipitation[idx],
  statusTexto.includes("Tempestade")
);

const carro = avaliarCarro(
  atual.hourly.precipitation_probability[idx],
  vis,
  atual.current_weather.windspeed
);


const piscina = avaliarPiscina(
  atual.current_weather.temperature,
  atual.hourly.precipitation_probability[idx],
  atual.current_weather.windspeed
);

const alergiasTexto = avaliarAlergias(
  atual.hourly.relativehumidity_2m?.[idx] ?? 50,
  atual.hourly.windspeed_10m?.[idx] ?? 0,
  estacao
);

const gripeTexto = avaliarGripeResfriado(
  atual.hourly.relativehumidity_2m?.[idx] ?? 50,
  atual.current_weather.temperature
);

const mosquitosTexto = avaliarMosquitos(
  atual.hourly.relativehumidity_2m?.[idx] ?? 50,
  atual.hourly.precipitation_probability?.[idx] ?? 0,
  atual.current_weather.temperature
);

const pragasTexto = avaliarPragas(
  atual.current_weather.temperature,
  atual.hourly.precipitation_probability[idx],
  atual.hourly.relativehumidity_2m[idx]
);

  /* ===== IMPACTO SOMENTE BRASIL ===== */
  let impactoTexto = "";
  const paisNorm = (pais || "").toUpperCase().trim();

  if (paisNorm === "BR" || paisNorm === "BRA" || paisNorm.includes("BRASIL") || paisNorm.includes("BRAZIL")) {

    const mapaEstados = {
      "RIO GRANDE DO SUL":"RS","SANTA CATARINA":"SC","PARANA":"PR",
      "SAO PAULO":"SP","RIO DE JANEIRO":"RJ","MINAS GERAIS":"MG","ESPIRITO SANTO":"ES",
      "MATO GROSSO":"MT","MATO GROSSO DO SUL":"MS","GOIAS":"GO","DISTRITO FEDERAL":"DF",
      "BAHIA":"BA","SERGIPE":"SE","ALAGOAS":"AL","PERNAMBUCO":"PE","PARAIBA":"PB",
      "RIO GRANDE DO NORTE":"RN","CEARA":"CE","PIAUI":"PI","MARANHAO":"MA",
      "AMAZONAS":"AM","PARA":"PA","ACRE":"AC","RONDONIA":"RO","RORAIMA":"RR",
      "AMAPA":"AP","TOCANTINS":"TO"
    };

    let est = (estado || "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toUpperCase()
      .replace("ESTADO DE ", "")
      .replace(" STATE", "")
      .replace(" REGION", "")
      .trim();

    est = mapaEstados[est] ?? est;

    const regiaoPorEstado = {
      RS:"Sul",SC:"Sul",PR:"Sul",
      SP:"Sudeste",RJ:"Sudeste",MG:"Sudeste",ES:"Sudeste",
      MT:"Centro-Oeste",MS:"Centro-Oeste",GO:"Centro-Oeste",DF:"Centro-Oeste",
      BA:"Nordeste",SE:"Nordeste",AL:"Nordeste",PE:"Nordeste",PB:"Nordeste",
      RN:"Nordeste",CE:"Nordeste",PI:"Nordeste",MA:"Nordeste",
      AM:"Norte",PA:"Norte",AC:"Norte",RO:"Norte",RR:"Norte",AP:"Norte",TO:"Norte"
    };

    const impacto = {
      Sul:{
        "El Ni√±o":"Chuvas acima da m√©dia e temporais",
        "La Ni√±a":"Frio intenso e tempo mais seco",
        "Neutro":"Clima pr√≥ximo do normal"
      },
      Sudeste:{
        "El Ni√±o":"Calor forte e chuva irregular",
        "La Ni√±a":"Ver√µes mais chuvosos",
        "Neutro":"Padr√£o t√≠pico"
      },
      "Centro-Oeste":{
        "El Ni√±o":"Calor e chuva mal distribu√≠da",
        "La Ni√±a":"Chuvas mais constantes",
        "Neutro":"Condi√ß√µes normais"
      },
      Nordeste:{
        "El Ni√±o":"Tend√™ncia a seca",
        "La Ni√±a":"Mais epis√≥dios de chuva",
        "Neutro":"Vari√°vel"
      },
      Norte:{
        "El Ni√±o":"Menos chuva na Amaz√¥nia",
        "La Ni√±a":"Chuvas acima da m√©dia",
        "Neutro":"Regime normal"
      }
    };

    const regiao = regiaoPorEstado[est];
    if (regiao && impacto[regiao]?.[fenomeno]) {
      impactoTexto = `Impacto no ${regiao}:${impacto[regiao][fenomeno]}`;
    }
  }

// üåä PRAIA
const possuiPraia = cidadePossuiPraia(
  (pais || "").toUpperCase(),
  lat,
  lon
);

const praia = possuiPraia
  ? avaliarPraia(
      atual.current_weather.temperature,
      atual.hourly.precipitation_probability[idx],
      atual.current_weather.windspeed,
      atual.daily.uv_index_max?.[0] ?? 0
    )
  : "üèñÔ∏èN/A";


// 1Ô∏è‚É£ Calcular Hor√°rio de Ouro e avalia√ß√£o de fotografia
const horarioOuro = calcularHorarioOuroCompacto(atual.daily.sunrise[0], atual.daily.sunset[0]);
const avaliacaoFoto = avaliarFotografia(
  atual.current_weather.temperature,
  nebulosidade,
  atual.hourly.precipitation_probability[idx],
  atual.daily.sunrise[0],
  atual.daily.sunset[0]
);

// Monta a exibi√ß√£o da fotografia com Hor√°rio de Ouro
const fotografia = `${avaliacaoFoto} (Hor√°rio de Ouro: ${horarioOuro})`;

/* ===== MONTA LINHA STATUS FINAL ===== */

const mobileView = true; //Avaliar isto, true = Android / false = desktop
const alertaTexto = "";
linhaStatus.innerHTML = `
  ${!mobileView ? `
    <div>üïí Data e Hora da Coleta: <b>${dataHoraLocal ?? ""}</b></div>
  ` : ""}

  ${chuvaTexto ? `<div>üåßÔ∏è ${chuvaTexto}</div>` : ""}

  ${pressaoTexto && !mobileView ? `<div>üìâ ${pressaoTexto}</div>` : ""}

  ${alertaTexto ? `<div class="alerta">‚ö†Ô∏è ${alertaTexto}</div>` : ""}

  <div style="margin-top:6px">
  <b style="color:#8B008B;font-size:14px;">
    Atividades ao Ar Livre (<b>Qualidade do Ar:</b> ${formatarAQ(usAQI)})
  </b><br>
  ${corrida ?? ""} 
  ${caminhada ?? ""} 
  ${ciclismo ?? ""} 
  ${estrelas ?? ""} 
  ${pesca ?? ""} 
  ${churrascoTexto ? ` üçñ${churrascoTexto}` : ""}
  
</div>
  <div style="margin-top:4px">
    <b style="color:#8B008B;font-size:14px;">
Fotografia</b><br>
  ${fotografia}
  </div>

  <div style="margin-top:4px">
    <b style="color:#8B008B;font-size:14px;">Praia / Piscina</b><br>
    ${praia ?? ""} ${piscina ?? ""}
  </div>

  <div style="margin-top:4px">
    <b style="color:#8B008B;font-size:14px;">Tr√¢nsito / Viagens</b><br>
    ${aviao ?? ""} ${carro ?? ""}
  </div>

  ${alergiasTexto ? `
  <div style="margin-top:4px">
    <b style="color:#8B008B;font-size:14px;">Sa√∫de/Bem Estar</b><br>
   </b>${alergiasTexto} 
    <b style="color:#8B008B;font-size:14px;">  (üò∑üå°Ô∏èü§í)</b>${gripeTexto}
  </div>
` : ""}

  ${mosquitosTexto || pragasTexto ? `
  <div style="margin-top:4px">
    <b style="color:#8B008B;font-size:14px;">Pragas/Insetos</b><br>
    ${mosquitosTexto}${pragasTexto ? ` ${pragasTexto}` : ""}
  </div>
` : ""}

  <div style="margin-top:6px">
    <b style="color:#8B008B;font-size:14px;">üóìÔ∏è Esta√ß√£o:</b> ${estacao ?? "-"}
  </div>

  <div>
    üåä <b style="color:#8B008B;font-size:14px;">Fen√¥meno:</b> ${fenomeno ?? "-"}${impactoTexto ? ` (${impactoTexto})` : ""}
  </div>
`;
}

 /* =========================
    LINHA DO SOL
 ========================= */
 montarLinhaSol(atual.daily);
 montarPrevisao5Dias(atual.daily);
 montarGraficoPrevisao(atual.daily);

 /* =========================
    HIST√ìRICO (30 DIAS)
 ========================= */
 const hoje = new Date();
 const ontem = new Date(hoje); ontem.setDate(hoje.getDate()-1);
 const ini = new Date(ontem); ini.setDate(ontem.getDate()-30);

 const rHist = await fetch(
  `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}` +
  `&start_date=${ini.toISOString().split("T")[0]}` +
  `&end_date=${ontem.toISOString().split("T")[0]}` +
  `&hourly=pressure_msl,precipitation&timezone=UTC`
 );
 const hist = await rHist.json();
 histSalvo = hist.hourly;

 calcularPressaoChuva(hist.hourly);
 montarGrafico(hist.hourly);
 buscarTemperaturasMensais();
}

/* =========================
   PM2.5 ‚Üí US AQI
========================= */
function pm25ToUSAQI(pm25){
 if(pm25<=12) return Math.round((50/12)*pm25);
 if(pm25<=35.4) return Math.round(((100-51)/(35.4-12.1))*(pm25-12.1)+51);
 if(pm25<=55.4) return Math.round(((150-101)/(55.4-35.5))*(pm25-35.5)+101);
 if(pm25<=150.4) return Math.round(((200-151)/(150.4-55.5))*(pm25-55.5)+151);
 if(pm25<=250.4) return Math.round(((300-201)/(250.4-150.5))*(pm25-150.5)+201);
 if(pm25<=350.4) return Math.round(((400-301)/(350.4-250.5))*(pm25-250.5)+301);
 if(pm25<=500.4) return Math.round(((500-401)/(500.4-350.5))*(pm25-350.5)+401);
 return 500;
}

/* =========================
   HIST√ìRICO MENSAL (12 MESES)
========================= */

async function buscarTemperaturasMensais(){
  const hoje = new Date();
  const inicio = new Date(hoje.getFullYear()-1, hoje.getMonth(), 1);

  const r = await fetch(
    `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}` +
    `&start_date=${inicio.toISOString().split("T")[0]}` +
    `&end_date=${hoje.toISOString().split("T")[0]}` +
    `&daily=temperature_2m_min,temperature_2m_max,temperature_2m_mean` +
    `&timezone=auto`
  );

  const d = await r.json();
  if(!d?.daily?.time) return;

  const meses = {};

  d.daily.time.forEach((t,i)=>{
    const m = t.slice(0,7); // YYYY-MM
    meses[m] ??= {min:[], max:[], med:[]};

    meses[m].min.push(d.daily.temperature_2m_min[i]);
    meses[m].max.push(d.daily.temperature_2m_max[i]);
    meses[m].med.push(d.daily.temperature_2m_mean[i]);
  });

  const labels = [];
  const min = [];
  const max = [];
  const med = [];

  const nomesMes = [
  "Jan","Fev","Mar","Abr","Mai","Jun",
  "Jul","Ago","Set","Out","Nov","Dez"
];

Object.keys(meses).slice(-12).forEach(m=>{
  const [ano,mes] = m.split("-");

  labels.push(`${nomesMes[Number(mes)-1]}/${ano.slice(2)}`);

  min.push(media(meses[m].min).toFixed(1));
  max.push(media(meses[m].max).toFixed(1));
  med.push(media(meses[m].med).toFixed(1));
});

  montarGraficoMensal(labels, min, med, max);
}

function media(arr){
  return arr.reduce((a,b)=>a+b,0) / arr.length;
}

function montarGraficoMensal(labels, min, med, max){
  chartMensal?.destroy();

  chartMensal = new Chart(
    document.getElementById("graficoMensal"),
    {
      type:"line",
      data:{
        labels,
        datasets:[
          {
            label:"M√≠nima(¬∞C)",
            data:min,
            tension:.35,
            borderWidth:2,
            pointRadius:4
          },
          {
            label:"M√©dia(¬∞C)",
            data:med,
            tension:.35,
            borderWidth:3,
            pointRadius:4
          },
          {
            label:"M√°xima(¬∞C)",
            data:max,
            tension:.35,
            borderWidth:2,
            pointRadius:4
          }
        ]
      },
      options:{
        plugins:{
          title:{
            display:true,
            text:"Temperatura Mensal - √∫ltimos 12 Meses ‚Äî M√≠n., M√©dia e M√°x.",
            font:{size:13, weight:"bold"},
            color:document.body.classList.contains("dark") ? "#e6edf3" : "#000"
          }
        },
        scales: {
          x: {
            ticks: {
              color: "#006400", // verde escuro
              font: {
                size: 12,
                weight: "bold"
              }
            }
          },
          y: {
            ticks: {
              color: "#006400" // opcional: se quiser o eixo Y tamb√©m verde escuro
            }
          }
        }
      }
    }
  );
}

function avaliarPesca(pressao, vento, chuva){
  if (pressao >= 1015 && vento <= 8 && chuva === 0)
    return "üé£Boa ";
  if (pressao >= 1008 && vento <= 12 && chuva < 40)
    return "üé£Regular ";
  return "üé£Ruim ";
}

function avaliarChurrasco(temperatura, precipitacao, vento) {
  // temperatura ideal entre 20¬∞C e 35¬∞C
  // pouca chance de chuva (<30%)
  // vento leve (<20 km/h)
  if (temperatura >= 20 && temperatura <= 35 && precipitacao < 30 && vento < 20) {
    return "√ìtimo!";
  } else if (temperatura >= 15 && temperatura <= 40 && precipitacao < 50) {
    return "Fique atento ao tempo.";
  } else {
    return "Melhor adiar.";
  }
}
/* =========================
   HOR√ÅRIO DE OURO (Fotografia)
========================= */
function calcularHorarioOuro(dia, duracaoMinutos = 90) {
  if (!dia?.sunrise?.[0] || !dia?.sunset?.[0]) return "-";

  const nascer = new Date(dia.sunrise[0]);
  const porDoSol = new Date(dia.sunset[0]);

  const manhaInicio = nascer;
  const manhaFim = new Date(nascer.getTime() + duracaoMinutos * 60000);

  const tardeFim = porDoSol;
  const tardeInicio = new Date(porDoSol.getTime() - duracaoMinutos * 60000);

  function formatHHMM(dt){
    return `${String(dt.getHours()).padStart(2,"0")}:${String(dt.getMinutes()).padStart(2,"0")}`;
  }

  return `üì∏ Hora de ouro: ${formatHHMM(manhaInicio)}hs‚Äì${formatHHMM(manhaFim)}hs / ${formatHHMM(tardeInicio)}hs ‚Äì${formatHHMM(tardeFim)}hs;`
}

function avaliarFotografia(temp, nebulosidade, chuvaProb, nascerSol, porSol) {
  // Se muito nublado ou chuvoso = ruim
  if (chuvaProb > 50 || nebulosidade > 70) return "üì∑Ruim";
  
  // Condi√ß√µes intermedi√°rias
  if (chuvaProb > 20 || nebulosidade > 40) return "üì∑M√©dio";
  
  // C√©u limpo = bom
  return "üì∑Bom";
}

function calcularHorarioOuroCompacto(sunrise, sunset){
  // sunrise e sunset em formato "YYYY-MM-DDTHH:MM"
  const formatarHora = (d) => `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;

  const nascer = new Date(sunrise);
  const por = new Date(sunset);

  // Manh√£: nascer do sol at√© +1h30
  const manhaInicio = nascer;
  const manhaFim = new Date(nascer.getTime() + 90*60*1000); // +1h30 em ms

  // Tarde: -1h30 at√© p√¥r do sol
  const tardeInicio = new Date(por.getTime() - 90*60*1000); 
  const tardeFim = por;

  return `${formatarHora(manhaInicio)} - ${formatarHora(manhaFim)} e ${formatarHora(tardeInicio)} - ${formatarHora(tardeFim)}`;
}

function avaliarCorrida(temp, chuva, vento, uv){
  if (temp >= 15 && temp <= 28 && chuva < 20 && vento <= 12 && uv <= 7)
    return "üèÉBoa ";
  if (temp >= 10 && temp <= 32 && chuva < 40)
    return "üèÉRegular ";
  return "üèÉN√£o indicada ";
}

function avaliarCaminhada(temp, chuvaProb, vento, uv, vis) {

  // ‚ùå condi√ß√µes ruins
  if (chuvaProb > 60 || vento > 30 || vis < 1500)
    return "üö∂Ruim ";

  // ‚ö†Ô∏è condi√ß√µes razo√°veis
  if (
    (temp >= 10 && temp < 15) ||
    (temp > 30 && temp <= 35) ||
    chuvaProb >= 30 ||
    vento > 20 ||
    uv > 8
  )
    return "ü•æRazo√°vel ";

  // ‚úÖ condi√ß√µes boas
  if (temp >= 15 && temp <= 30 && chuvaProb < 30 && vento <= 20 && uv <= 7)
    return "ü•æBoa ";

  return "ü•æRazo√°vel ";
}

function avaliaCiclismo(probChuva, vento, pressao) {
  if (probChuva > 50 || vento > 25 || pressao < 1008)
    return "üö¥N√£o recomendado ";
  if (vento <= 10 && probChuva < 20)
    return "üö¥Bom ";
  return "üö¥Regular ";
}

function avaliarAviao(vento, vis, chuva, tempestade){
  if (tempestade || vento > 35 || vis < 2000)
    return "‚úàÔ∏èRisco elevado ";
  if (vento > 20 || chuva > 2)
    return "‚úàÔ∏èAten√ß√£o! ";
  return "‚úàÔ∏èV√¥o tranquilo ";
}

function avaliarCarro(chuvaProb, vis, vento){
  if (chuvaProb > 70 || vis < 1500)
    return "üöóCuidado na estrada! ";
  if (chuvaProb > 40 || vento > 30)
    return "üöóAten√ß√£o na estrada! ";
  return "üöóBoa Dirigibilidade ";
}

function avaliarAlergias(umidade, vento, estacao) {
  // condi√ß√µes boas
  if (umidade >= 50 && vento <= 15)
    return "(ü§ßüåæüëÄüëÉ)Baixa";

  // condi√ß√µes intermedi√°rias
  if (umidade >= 35 && vento <= 25)
    return "(ü§ßüåæüëÄüëÉ)Moderada";

  // tempo seco ou muito vento
  return "(ü§ßüåæüëÄüëÉ)Alta";
}

function avaliarGripeResfriado(umidade, temp) {
  // Exemplo: maior risco com temperatura baixa e umidade baixa
  if (temp <= 18 && umidade <= 40) return "Alto risco";
  if (temp <= 22 && umidade <= 50) return "M√©dio risco";
  return "Baixo risco";
}

function avaliarMosquitos(umidade, chuvaProb, temp) {
  if (umidade == null || chuvaProb == null || temp == null)
    return "";

  // risco alto
  if (umidade >= 75 && (chuvaProb >= 40 || temp >= 28))
    return "(ü¶ü)Elevado";

  // risco m√©dio
  if (umidade >= 60 || chuvaProb >= 20)
    return "(ü¶ü)M√©dio";

  // risco baixo
  return "(ü¶ü) Baixo";
}


/* =========================
   AVALIAR PRAGAS (S√ì AR LIVRE)
========================= */
function avaliarPragas(temp, chuva, umidade) {
  /*
    temp: temperatura atual em ¬∞C
    chuva: probabilidade de chuva em %
    umidade: umidade relativa em %
    
    Retorna uma string indicando risco de pragas
  */

  if(temp >= 25 && umidade >= 70 && chuva < 50){
    return "(ü™∞ü™≥üï∑Ô∏è)Alto risco de pragas ao ar livre";
  } else if(temp >= 20 && umidade >= 60){
    return "(ü™∞ü™≥üï∑Ô∏è) M√©dio risco de pragas ao ar livre";
  } else {
    return "(ü™∞ü™≥üï∑Ô∏è)Baixo risco de pragas ao ar livre";
  }
}

/* =========================
   FUN√á√ïES UTILIT√ÅRIAS
========================= */

function normalizarEstadoParaSigla(estado){
  if (!estado) return "";

  const mapaEstados = {
    "RIO GRANDE DO SUL":"RS","SANTA CATARINA":"SC","PARANA":"PR",
    "SAO PAULO":"SP","RIO DE JANEIRO":"RJ","ESPIRITO SANTO":"ES",
    "BAHIA":"BA","SERGIPE":"SE","ALAGOAS":"AL","PERNAMBUCO":"PE",
    "PARAIBA":"PB","RIO GRANDE DO NORTE":"RN","CEARA":"CE","PIAUI":"PI",
    "MARANHAO":"MA","PARA":"PA","AMAPA":"AP"
  };

  const chave = estado
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toUpperCase()
    .replace("ESTADO DE ","")
    .trim();
}

function avaliarPiscina(temp, chuvaProb, vento){
  if (chuvaProb > 60)
    return "üèäN√£o recomendado ";
  if (temp >= 22 && chuvaProb < 30 && vento <= 20)
    return "üèäBoa ";
  return "üèäRegular ";
}

function avaliarEstrelas(nebulosidade, chuvaProb, luaIluminacao) {
  // Nebulosidade baixa, pouca chuva e lua fraca = c√©u bom
  if (nebulosidade <= 20 && chuvaProb < 20 && luaIluminacao <= 30)
    return "üî≠Boa ";

  // Condi√ß√µes intermedi√°rias
  if (nebulosidade <= 50 && chuvaProb < 40)
    return "üî≠Razo√°vel ";

  // Muito nublado, chuva ou lua cheia
  return "üî≠Ruim ";
}

/* =========================
   FORMATADORES
========================= */
function formatarAQ(v){
 if(v<=50) return `<span class="aq-bom">Boa (${v})</span>`;
 if(v<=100) return `<span class="aq-mod">Moderada (${v})</span>`;
 if(v<=150) return `<span class="aq-ruim">Insalubre (${v})</span>`;
 if(v<=200) return `<span class="aq-muito">Muito Insalub. (${v})</span>`;
 if(v<=300) return `<span class="aq-severo">Severo (${v})</span>`;
 return `<span class="aq-extremo">Extrema (${v})</span>`;
}

function formatarUV(v){
 let classe="",descricao="";
 if(v<=2){classe="aq-bom";descricao="Baixo";}
 else if(v<=5){classe="aq-mod";descricao="M√©dio";}
 else if(v<=7){classe="aq-ruim";descricao="Alto";}
 else if(v<=10){classe="aq-muito";descricao="Muito Alto";}
 else{classe="aq-extremo";descricao="Extremo";}
 return {classe,descricao};
}

/* =========================
   LUA
========================= */
function calcularLua(data){
  const ref = new Date(Date.UTC(2000, 0, 6, 18, 14, 0));
  const ciclo = 29.530588853;

  const dias = (data.getTime() - ref.getTime()) / 86400000;
  const idade = ((dias % ciclo) + ciclo) % ciclo;
  const frac = idade / ciclo;

  const iluminacao = Math.round(
    (1 - Math.cos(2 * Math.PI * frac)) / 2 * 100
  );

  let fase = "";

  if (idade < 1.84566) fase = "Lua Nova üåë";
  else if (idade < 5.53699) fase = "Lua Crescente üåí";
  else if (idade < 9.22831) fase = "Quarto Crescente üåì";
  else if (idade < 12.91963) fase = "Crescente Gibosa üåî";
  else if (idade < 16.61096) fase = "Lua Cheia üåï";
  else if (idade < 20.30228) fase = "Minguante Gibosa üåñ";
  else if (idade < 23.99361) fase = "Quarto Minguante üåó";
  else if (idade < 27.68493) fase = "Lua Minguante üåò";
  else fase = "Lua Nova üåë";

  return {
    fase,
    iluminacao,
    idade: idade.toFixed(1)
  };
}

function formatarChuvaClasse(v){
 if(v<=20) return "chuva-bom";
 if(v<=40) return "chuva-mod";
 if(v<=60) return "chuva-ruim";
 if(v<=80) return "chuva-muito";
 return "chuva-extremo";
}

// =========================
// HOR√ÅRIO DE OURO
// =========================
function horarioDeOuro(lat, lon, data = new Date()) {
  // Usa o nascer e p√¥r do sol aproximado
  const sunrise = SunCalc.getTimes(data, lat, lon).sunrise;
  const sunset = SunCalc.getTimes(data, lat, lon).sunset;

  // Golden hour: 1 hora ap√≥s nascer do sol / 1 hora antes do p√¥r do sol
  const inicio = new Date(sunrise.getTime() + 0 * 60 * 60 * 1000); // pode ajustar se quiser +0
  const fim = new Date(sunset.getTime() - 0 * 60 * 60 * 1000);

  const pad = n => String(n).padStart(2, "0");
  return `${pad(inicio.getHours())}:${pad(inicio.getMinutes())} - ${pad(fim.getHours())}:${pad(fim.getMinutes())}`;
}





/* =========================
   STATUS
========================= */
function definirStatus(p,c){
 linhaStatus.className="linha-status";
 if(c>8||p<1005){
  linhaStatus.classList.add("tempestade");
  linhaStatus.innerText="‚õàÔ∏èTempo:Risco de Tempestade";
 }
 else if(c>1||p<1012){
  linhaStatus.classList.add("chuva");
  linhaStatus.innerText="üåßÔ∏èTempo:Possibilidade de chuva";
 }
 else{
  linhaStatus.classList.add("bom");
  linhaStatus.innerText="‚òÄÔ∏èTempo:Tempo bom";
 }
}

/* =========================
   SOL
========================= */
function montarLinhaSol(d){
 if(!d?.time) return;
 const diasSemana=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
 linhaSol.innerHTML="";
 for(let i=0;i<4;i++){
  const p=d.time[i].split("-");
  const data=new Date(p[0],p[1]-1,p[2]);
  linhaSol.innerHTML+=`
   <div class="sol-dia">
    ${p[2]}/${p[1]}<br>
    ${diasSemana[data.getDay()]}<br>
    üåÖ ${d.sunrise[i].slice(11,16)}<br>
    üåá ${d.sunset[i].slice(11,16)}
   </div>`;
 }
}

/* =========================
   PREVIS√ÉO 5 DIAS
========================= */
function montarPrevisao5Dias(d){
 if(!d?.time) return;
 const diasSemana=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
 previsao5.innerHTML="";
 for(let i=0;i<5;i++){
  const p=d.time[i].split("-");
  const data=new Date(p[0],p[1]-1,p[2]);
  previsao5.innerHTML+=`
   <div class="previsao-dia">
    ${p[2]}/${p[1]}<br>
    ${diasSemana[data.getDay()]}<br>
    üåßÔ∏è ${d.precipitation_sum[i]}mm (${d.precipitation_probability_max[i]}%)<br>
    ${d.temperature_2m_min[i]}¬∞ / ${d.temperature_2m_max[i]}¬∞
   </div>`;
 }
}

/* =========================
   PRESS√ÉO √ó CHUVA
========================= */
function calcularPressaoChuva(h){
 if(!h?.time) return;
 const dias={};
 h.time.forEach((t,i)=>{
  const d=t.split("T")[0];
  dias[d]??={p:[],mm:0};
  dias[d].p.push(h.pressure_msl[i]);
  dias[d].mm+=h.precipitation[i];
 });
 const press=[];
 Object.values(dias).forEach(d=>{
  if(d.mm>=1) press.push(d.p.reduce((a,b)=>a+b)/d.p.length);
 });
 if(press.length<3){
  linhaAviso.innerHTML="üåßÔ∏è *Dados insuficientes para padr√£o confi√°vel.";
  return;
 }
}

/* =========================
   GR√ÅFICOS
========================= */
function montarGraficoPrevisao(d){
 chartPrevisao?.destroy();
 chartPrevisao=new Chart(
  document.getElementById("graficoPrevisao"),{
   data:{
    labels:d.time.map(t=>t.slice(8,10)+"/"+t.slice(5,7)),
    datasets:[
     {type:"bar",label:"Chuva (mm)",data:d.precipitation_sum},
     {type:"bar",label:"Prob. chuva (%)",data:d.precipitation_probability_max},
     {type:"line",label:"Temp Min (¬∞C)",data:d.temperature_2m_min},
     {type:"line",label:"Temp Max (¬∞C)",data:d.temperature_2m_max}
    ]
   },
   options:{
    plugins:{
     title:{
      display:true,
      text:"Previs√£o de Chuva e Temperatura ‚Äî 7 dias",
      font:{size:12,weight:"bold"},
      color:document.body.classList.contains("dark")?"#e6edf3":"#000"
     }
    }
   }
  }
 );
}

function montarGrafico(h){
 if(!h?.time) return;

 const dias={}, chuva={};

 h.time.forEach((t,i)=>{
  const d=t.split("T")[0];
  dias[d] ??= [];
  dias[d].push(h.pressure_msl[i]);
  chuva[d]=(chuva[d]||0)+h.precipitation[i];
 });

 const labels=[], press=[], mm=[];
 Object.keys(dias).slice(-5).forEach(d=>{
  const p=d.split("-");
  labels.push(`${p[2]}/${p[1]}`);
  press.push((dias[d].reduce((a,b)=>a+b)/dias[d].length).toFixed(1));
  mm.push(chuva[d].toFixed(1));
 });

 chart?.destroy();
 chart=new Chart(
  document.getElementById("grafico"),{
   data:{
    labels,
    datasets:[
     {type:"line",label:"Press√£o M√©dia (hPa)",data:press,borderWidth:2,tension:.3},
     {type:"bar",label:"Chuva Acumulada (mm)",data:mm,yAxisID:"y1"}
    ]
   },
   options:{
    plugins:{
     title:{
      display:true,
      text:"Press√£o Atmosf√©rica √ó Chuva ‚Äî √öltimos 5 dias",
      font:{size:12,weight:"bold"},
      color:document.body.classList.contains("dark")?"#e6edf3":"#000"
     }
    },
    scales:{
     y:{title:{display:true,text:"Press√£o (hPa)"}},
     y1:{
      position:"right",
      beginAtZero:true,
      grid:{drawOnChartArea:false},
      title:{display:true,text:"Chuva (mm)"}
     }
    }
   }
  }
 );
}

/* =========================
   GEOLOCALIZA√á√ÉO INICIAL
========================= */
navigator.geolocation?.getCurrentPosition(async p=>{
  lat = p.coords.latitude;
  lon = p.coords.longitude;

  const estadoGeo = await obterEstadoPorLatLon(lat, lon);

  paisSelecionado = "BR";
  estadoSelecionado = estadoGeo; 

  cidade.value = estadoGeo
    ? `Localiza√ß√£o - ${estadoGeo}`
    : "Sua Localiza√ß√£o";

  let nomeExibir = "Localiza√ß√£o";
  if (paisSelecionado === "BR" && estadoGeo) {
      const mapaEstados = {
        "RIO GRANDE DO SUL":"RS","SANTA CATARINA":"SC","PARANA":"PR",
        "SAO PAULO":"SP","RIO DE JANEIRO":"RJ","MINAS GERAIS":"MG","ESPIRITO SANTO":"ES",
        "MATO GROSSO":"MT","MATO GROSSO DO SUL":"MS","GOIAS":"GO","DISTRITO FEDERAL":"DF",
        "BAHIA":"BA","SERGIPE":"SE","ALAGOAS":"AL","PERNAMBUCO":"PE","PARAIBA":"PB",
        "RIO GRANDE DO NORTE":"RN","CEARA":"CE","PIAUI":"PI","MARANHAO":"MA",
        "AMAZONAS":"AM","PARA":"PA","ACRE":"AC","RONDONIA":"RO","RORAIMA":"RR",
        "AMAPA":"AP","TOCANTINS":"TO"
      };

      const sigla = mapaEstados[estadoGeo] ?? "";
      nomeExibir = estadoGeo.charAt(0) + estadoGeo.slice(1).toLowerCase() + (sigla ? ` (${sigla})` : "");
  }

  nomeCidade.innerText = nomeExibir;

  await buscar();
});

</script>
</body>
</html>
