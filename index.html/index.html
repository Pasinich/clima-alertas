<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & Alertas Inteligentes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(135deg,#1565c0,#26c6da);
  color:#fff;
  padding:16px;
}
h2{text-align:center}

.card{
  background:rgba(255,255,255,.18);
  border-radius:18px;
  padding:18px;
  margin-bottom:18px;
}

input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  font-size:16px;
  border:none;
  border-radius:12px;
}

button{
  background:#00e676;
  font-weight:bold;
}

.resultado{margin-top:8px;font-size:18px}
.status{font-size:20px;font-weight:bold;margin-top:10px}

canvas{
  background:#fff;
  border-radius:12px;
  padding:10px;
}

/* AUTOCOMPLETE */
.autocomplete{
  background:#fff;
  color:#000;
  border-radius:10px;
  overflow:hidden;
  margin-top:4px;
}
.autocomplete div{
  padding:10px;
  cursor:pointer;
}
.autocomplete div:hover{
  background:#e0e0e0;
}
</style>
</head>

<body>

<h2 id="titulo">ğŸŒ¦ï¸ Clima & Alertas</h2>

<div class="card">

  <input id="cidadeInput" placeholder="Digite a cidade (ex: ChapecÃ³)">
  <div id="listaCidades" class="autocomplete"></div>

  <div class="resultado" id="local">ğŸ“ Nenhuma cidade selecionada</div>

  <button onclick="buscarClima()">Consultar Ãºltimos 7 dias</button>

  <div class="resultado" id="pressao"></div>
  <div class="resultado" id="chuva"></div>
  <div class="resultado" id="variacao"></div>
  <div class="resultado" id="comparacao"></div>
  <div class="status" id="status"></div>

</div>

<div class="card">
  <h3>ğŸ“Š PressÃ£o atmosfÃ©rica â€“ Ãºltimos 7 dias</h3>
  <canvas id="grafico"></canvas>
</div>

<script>
let lat = null;
let lon = null;
let chart = null;

const cidadeInput = document.getElementById("cidadeInput");
const lista = document.getElementById("listaCidades");
const localDiv = document.getElementById("local");
const titulo = document.getElementById("titulo");

const pressaoDiv = document.getElementById("pressao");
const chuvaDiv = document.getElementById("chuva");
const variacaoDiv = document.getElementById("variacao");
const comparacaoDiv = document.getElementById("comparacao");
const statusDiv = document.getElementById("status");
const grafico = document.getElementById("grafico");

/* ğŸ” AUTOCOMPLETE */
cidadeInput.addEventListener("input", async ()=>{
  const q = cidadeInput.value.trim();
  lista.innerHTML = "";
  if(q.length < 3) return;

  const url =
    `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=5&language=pt`;

  const r = await fetch(url);
  const d = await r.json();

  if(!d.results) return;

  d.results.forEach(c=>{
    const div = document.createElement("div");
    div.textContent =
      `${c.name}${c.admin1 ? " â€“ "+c.admin1 : ""}`;
    div.onclick = ()=>{
      lat = c.latitude;
      lon = c.longitude;
      lista.innerHTML = "";
      cidadeInput.value = c.name;
      localDiv.innerHTML = `ğŸ“ ${div.textContent}`;
      titulo.innerText = `ğŸŒ¦ï¸ Clima & Alertas â€¢ ${c.name}`;
    };
    lista.appendChild(div);
  });
});

/* ğŸŒ¦ï¸ BUSCAR CLIMA */
async function buscarClima(){
  if(lat === null){
    alert("Selecione uma cidade");
    return;
  }

  const url =
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=pressure_msl,precipitation&past_days=7&timezone=America/Sao_Paulo`;

  const r = await fetch(url);
  const d = await r.json();
  processarDados(d);
}

/* â±ï¸ HOURLY â†’ DAILY (SÃ“ DIAS PASSADOS) */
function processarDados(d){
  const hoje = new Date().toISOString().slice(0,10);
  const dias = {};

  d.hourly.time.forEach((t,i)=>{
    const dia = t.split("T")[0];
    if(dia > hoje) return;

    if(!dias[dia]) dias[dia] = {p:[], c:0};
    dias[dia].p.push(d.hourly.pressure_msl[i]);
    dias[dia].c += d.hourly.precipitation[i];
  });

  const labels = [];
  const pressao = [];
  const chuva = [];

  Object.keys(dias).slice(-7).forEach(dia=>{
    labels.push(dia);
    pressao.push(
      dias[dia].p.reduce((a,b)=>a+b) / dias[dia].p.length
    );
    chuva.push(dias[dia].c);
  });

  renderizar(labels, pressao, chuva);
}

/* ğŸ“Š RENDER */
function renderizar(labels, p, c){
  const hoje = p.at(-1);
  const media = p.slice(-5).reduce((a,b)=>a+b) / 5;

  pressaoDiv.innerHTML = `ğŸŒ¬ï¸ PressÃ£o: <b>${hoje.toFixed(1)} hPa</b>`;
  comparacaoDiv.innerHTML = `ğŸ“Š MÃ©dia 5 dias: ${media.toFixed(1)} hPa`;
  variacaoDiv.innerHTML = `ğŸ”„ DiferenÃ§a: ${(hoje-media).toFixed(1)} hPa`;
  chuvaDiv.innerHTML =
    c.at(-1) > 0 ? `ğŸŒ§ï¸ ${c.at(-1).toFixed(1)} mm` : "â˜€ï¸ Sem chuva";

  let risco = "ğŸŸ¢ Baixo";
  if(hoje < 1010) risco = "ğŸŸ¡ Moderado";
  if(hoje < 1007 || c.at(-1) > 20) risco = "ğŸ”´ Alto";
  statusDiv.innerText = `ğŸŒªï¸ Risco: ${risco}`;

  if(chart) chart.destroy();
  chart = new Chart(grafico,{
    type:"line",
    data:{
      labels,
      datasets:[{
        label:"PressÃ£o mÃ©dia diÃ¡ria (hPa)",
        data:p,
        borderWidth:3,
        tension:0.4
      }]
    }
  });
}
</script>

</body>
</html>