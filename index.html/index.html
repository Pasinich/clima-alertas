<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & Alertas Inteligentes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(135deg,#1565c0,#26c6da);
  color:#fff;
  padding:16px;
}
h2{text-align:center}
.card{
  background:rgba(255,255,255,.18);
  border-radius:18px;
  padding:18px;
  margin-bottom:18px;
}
button,input{
  width:100%;
  padding:12px;
  margin-top:10px;
  font-size:16px;
  border:none;
  border-radius:12px;
}
button{background:#00e676;font-weight:bold}
.resultado{margin-top:6px;font-size:18px}
.status{font-size:20px;font-weight:bold;margin-top:10px}
canvas{background:#fff;border-radius:12px;padding:10px}
</style>
</head>

<body>

<h2>ğŸŒ¦ï¸ Clima & Alertas Inteligentes</h2>

<div class="card">
  <div class="resultado" id="local">ğŸ“ Detectando cidade...</div>

  <input type="date" id="data">
  <button onclick="buscar()">Consultar</button>

  <div class="resultado" id="pressao"></div>
  <div class="resultado" id="chuva"></div>
  <div class="resultado" id="variacao"></div>
  <div class="resultado" id="comparacao"></div>
  <div class="status" id="status"></div>
</div>

<div class="card">
  <h3>ğŸ“Š PressÃ£o â€“ histÃ³rico</h3>
  <canvas id="grafico"></canvas>
</div>

<script>
/* ğŸ“ PADRÃƒO (ChapecÃ³ - SC) */
let lat = -27.1000;
let lon = -52.6150;
let cidade = "ChapecÃ³";
let estado = "SC";

const dataInput = document.getElementById("data");
const pressaoDiv = document.getElementById("pressao");
const chuvaDiv = document.getElementById("chuva");
const variacaoDiv = document.getElementById("variacao");
const comparacaoDiv = document.getElementById("comparacao");
const statusDiv = document.getElementById("status");
const localDiv = document.getElementById("local");
const grafico = document.getElementById("grafico");

let chart;

/* ğŸ”„ GPS + CIDADE AUTOMÃTICOS */
window.onload = () => {
  if(!navigator.geolocation){
    localDiv.innerHTML = `ğŸ“ ${cidade} â€“ ${estado}`;
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos=>{
      lat = pos.coords.latitude;
      lon = pos.coords.longitude;
      obterCidadeEstado(lat, lon);
    },
    err=>{
      localDiv.innerHTML = `ğŸ“ ${cidade} â€“ ${estado}`;
    }
  );
};

/* ğŸŒ CONVERTE LAT/LON â†’ CIDADE/UF */
async function obterCidadeEstado(lat, lon){
  try{
    const url =
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`;

    const r = await fetch(url,{
      headers:{
        "User-Agent":"clima-alertas-app"
      }
    });
    const d = await r.json();

    cidade =
      d.address.city ||
      d.address.town ||
      d.address.village ||
      "Cidade nÃ£o identificada";

    estado =
      d.address.state_code ||
      d.address.state ||
      "";

    localDiv.innerHTML = `ğŸ“ ${cidade} â€“ ${estado}`;
  }catch(e){
    localDiv.innerHTML = `ğŸ“ ${cidade} â€“ ${estado}`;
  }
}

/* BUSCAR DADOS */
async function buscar(){
  if(!dataInput.value){
    alert("Selecione uma data");
    return;
  }

  let dados = await buscarArchive();
  if(!dados) dados = await buscarForecast();
  if(!dados){
    alert("Sem dados disponÃ­veis");
    return;
  }
  renderizar(dados);
}

/* ARCHIVE */
async function buscarArchive(){
  const fim = new Date(dataInput.value);
  const inicio = new Date(fim);
  inicio.setDate(inicio.getDate() - 30);

  const url =
    `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${inicio.toISOString().slice(0,10)}&end_date=${fim.toISOString().slice(0,10)}&daily=pressure_msl,precipitation_sum&timezone=America/Sao_Paulo`;

  try{
    const r = await fetch(url);
    const d = await r.json();
    if(d.daily?.pressure_msl?.length) return d;
  }catch(e){}
  return null;
}

/* FORECAST */
async function buscarForecast(){
  const url =
    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=pressure_msl,precipitation_sum&timezone=America/Sao_Paulo`;

  try{
    const r = await fetch(url);
    const d = await r.json();
    if(d.daily?.pressure_msl?.length) return d;
  }catch(e){}
  return null;
}

/* RENDER */
function renderizar(d){
  const pHoje = d.daily.pressure_msl.at(-1);
  const pMedia = d.daily.pressure_msl.slice(-7).reduce((a,b)=>a+b)/7;
  const chuva = d.daily.precipitation_sum.at(-1);

  pressaoDiv.innerHTML = `ğŸŒ¬ï¸ PressÃ£o: <b>${pHoje.toFixed(1)} hPa</b>`;
  comparacaoDiv.innerHTML = `ğŸ“Š MÃ©dia 7 dias: ${pMedia.toFixed(1)} hPa`;
  variacaoDiv.innerHTML = `ğŸ”„ DiferenÃ§a: ${(pHoje-pMedia).toFixed(1)} hPa`;
  chuvaDiv.innerHTML = chuva > 0 ? `ğŸŒ§ï¸ ${chuva} mm` : "â˜€ï¸ Sem chuva";

  let risco = "ğŸŸ¢ Baixo";
  if(pHoje < 1010) risco = "ğŸŸ¡ Moderado";
  if(pHoje < 1007 || chuva > 20) risco = "ğŸ”´ Alto";
  statusDiv.innerText = `ğŸŒªï¸ Risco: ${risco}`;

  if(chart) chart.destroy();
  chart = new Chart(grafico,{
    type:"line",
    data:{
      labels:d.daily.time,
      datasets:[{
        label:"PressÃ£o (hPa)",
        data:d.daily.pressure_msl,
        borderWidth:3,
        tension:0.4
      }]
    }
  });
}

dataInput.max = new Date().toISOString().slice(0,10);
</script>

</body>
</html>