<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & Press√£o Atmosf√©rica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* =========================
   VARI√ÅVEIS DE TEMA
========================= */
:root{
 --bg1:#1565c0;
 --bg2:#26c6da;
 --card:rgba(255,255,255,.18);
 --text:#fff;
 --grafico:#fff;
}
body.dark{
 --bg1:#0d1117;
 --bg2:#161b22;
 --card:rgba(255,255,255,.08);
 --text:#e6edf3;
 --grafico:#0d1117;
}

/* =========================
   ESTILO GLOBAL
========================= */
body{
 margin:0;
 font-family:Arial,sans-serif;
 background:linear-gradient(135deg,var(--bg1),var(--bg2));
 color:var(--text);
 padding:14px;
 transition:.3s;
}
header{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:6px;
}
h2{font-size:16px;margin:0;font-weight:normal;}
h2 span{font-weight:bold;}
button.toggle{
 background:rgba(255,255,255,.25);
 border:none;
 border-radius:50px;
 padding:6px;
 font-size:14px;
 cursor:pointer;
 color:var(--text);
}

/* =========================
   CARDS E INPUT
========================= */
.card{
 background:var(--card);
 border-radius:16px;
 padding:16px;
 margin-bottom:1px;
}
input{
 width:100%;
 padding:12px;
 border:none;
 border-radius:10px;
 font-size:14px;
}

/* =========================
   AUTOCOMPLETE
========================= */
.autocomplete{
 background:#fff;
 color:#000;
 border-radius:10px;
 margin-top:4px;
 position:absolute;
 z-index:10;
 width:calc(100% - 32px);
}
.autocomplete div{padding:10px;cursor:pointer;}
.autocomplete div:hover{background:#e0e0e0;}

/* =========================
   LINHAS DE INFORMA√á√ÉO
========================= */
.linha-info{margin-top:6px;font-size:14px;}
.linha-status{margin-top:6px;font-size:13px;font-weight:bold;padding:6px;border-radius:8px;}

.bom{background:#2e7d32;}
.chuva{background:#f9a825;color:#000;}
.tempestade{background:#c62828;}

/* =========================
   QUALIDADE DO AR
========================= */
.aq-bom{color:#0A3D0A;font-weight:bold;}
.aq-mod{color:#ffeb3b;font-weight:bold;}
.aq-ruim{color:#ff9800;font-weight:bold;}
.aq-muito{color:#f44336;font-weight:bold;}
.aq-severo{color:#f44336;font-weight:bold;}
.aq-extremo{color:#b71c1c;font-weight:bold;}

/* =========================
   CHUVA
========================= */
.chuva-bom{color:#0A3D0A;font-weight:bold;}
.chuva-mod{color:#ffeb3b;font-weight:bold;}
.chuva-ruim{color:#ff9800;font-weight:bold;}
.chuva-muito{color:#f44336;font-weight:bold;}
.chuva-extremo{color:#6a1b9a;}

/* =========================
   SOL
========================= */
#linha-sol{display:flex;gap:8px;margin-top:12px;}
.sol-dia{
 flex:1;
 background:#1a237e;
 border-radius:10px;
 padding:6px;
 height:45px;
 display:flex;
 flex-direction:column;
 justify-content:center;
 align-items:center;
 font-size:10px;
 font-weight:bold;
}
body.dark .sol-dia{background:#0b3c5d;}

/* =========================
   PREVIS√ÉO
========================= */
#previsao-5dias{
 display:flex;
 gap:6px;
 margin-top:4px;
 overflow-x:auto;
 margin-bottom:4px;
}
.previsao-dia{
 background:rgba(255,255,255,.18);
 border-radius:10px;
 padding:6px;
 min-width:80px;
 text-align:center;
 font-size:10px;
 font-weight:bold;
}

/* =========================
   GR√ÅFICOS
========================= */
canvas{
 background:var(--grafico);
 border-radius:10px;
 padding:8px;
 margin-top:1px;
}
</style>
</head>
<body>

<header>
 <h2>üå°Ô∏è Clima em: <span id="nome-cidade"></span></h2>
 <button class="toggle" id="toggleModo">üåô</button>
</header>

<div class="card">
 <input id="cidade" placeholder="Digite a cidade">
 <div id="lista" class="autocomplete"></div>

 <!-- ===== DADOS ATUAIS ===== -->
 <div id="info"></div>
 <div id="linha-pressao" class="linha-info"></div>
 <div id="linha-visibilidade" class="linha-info"></div>
 <div id="linha-vento" class="linha-info"></div>
 <div id="linha-umidade" class="linha-info"></div>
 <div id="linha-nevoeiro" class="linha-info"></div>
 <div id="linha-lua" class="linha-info"></div>
 <div id="linha-status" class="linha-status"></div>
 <div id="linha-aviso" class="linha-info"></div>

 <!-- ===== SOL E PREVIS√ÉO ===== -->
 <div id="linha-sol"></div>
 <div id="previsao-5dias"></div>
</div>

<div class="card">
 <canvas id="graficoPrevisao"></canvas>
</div>

<div class="card">
 <canvas id="grafico"></canvas>
</div>

<div class="card">
  <canvas id="graficoMensal"></canvas>
</div>

<script>

function limparTela(){
  info.innerHTML = "‚è≥ Carregando dados...";
  linhaPressao.innerHTML = "";
  linhaVisibilidade.innerHTML = "";
  linhaVento.innerHTML = "";
  linhaUmidade.innerHTML = "";
  linhaNevoeiro.innerHTML = "";
  linhaLua.innerHTML = "";
  linhaStatus.innerHTML = "";
  linhaAviso.innerHTML = "";
  linhaSol.innerHTML = "";
  previsao5.innerHTML = "";

  // destr√≥i gr√°ficos antigos
  chart?.destroy(); 
  chartPrevisao?.destroy();
  chartMensal?.destroy();

  chart = null;
  chartPrevisao = null;
  chartMensal = null;
}

/* =========================
   VARI√ÅVEIS GLOBAIS
========================= */
let lat=null, lon=null;
let chart=null, chartPrevisao=null;
let histSalvo=null;
let chartMensal = null;
let paisSelecionado = "";

/* =========================
   ELEMENTOS DOM
========================= */
const cidade=document.getElementById("cidade"),
lista=document.getElementById("lista"),
nomeCidade=document.getElementById("nome-cidade"),
info=document.getElementById("info"),
linhaPressao=document.getElementById("linha-pressao"),
linhaVisibilidade=document.getElementById("linha-visibilidade"),
linhaVento=document.getElementById("linha-vento"),
linhaUmidade=document.getElementById("linha-umidade"),
linhaNevoeiro=document.getElementById("linha-nevoeiro"),
linhaLua=document.getElementById("linha-lua"),
linhaStatus=document.getElementById("linha-status"),
linhaAviso=document.getElementById("linha-aviso"),
linhaSol=document.getElementById("linha-sol"),
previsao5=document.getElementById("previsao-5dias"),
btnModo=document.getElementById("toggleModo");

/* =========================
   MODO DIA / NOITE
========================= */
function aplicarModo(m){
 document.body.classList.toggle("dark", m==="dark");

 btnModo.innerHTML = m==="dark"
  ? "‚òÄÔ∏è <span style='font-size:10px'>Modo Dia</span>"
  : "üåô <span style='font-size:10px'>Modo Noite</span>";

 localStorage.setItem("modo", m);
 if(histSalvo) montarGrafico(histSalvo);
 if(chartPrevisao) chartPrevisao.update();
}

function modoAuto(){
 const h=new Date().getHours();
 const sys=matchMedia("(prefers-color-scheme: dark)").matches;
 return (h>=18 || h<=6 || sys) ? "dark" : "light";
}

aplicarModo(localStorage.getItem("modo") || modoAuto());

btnModo.onclick = () =>
 aplicarModo(document.body.classList.contains("dark") ? "light" : "dark");

/* =========================
   LIMPAR INPUT
========================= */
cidade.addEventListener("focus",()=>{
 cidade.value="";
 lista.innerHTML="";
});
/* =========================
   AUTOCOMPLETE DE CIDADES
========================= */
cidade.addEventListener("input",async()=>{
 lista.innerHTML="";
 if(cidade.value.length < 2) return;

 const r = await fetch(
  `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cidade.value)}&count=10&language=pt`
 );
 const d = await r.json();
 if(!d.results) return;

 d.results.forEach(c=>{
  const local = c.country_code==="BR" && c.admin1
   ? `${c.name} - ${c.admin1}`
   : `${c.name} - ${c.country}`;

  const div = document.createElement("div");
  div.innerText = local;
  div.onclick = ()=>{
  cidade.value = local;
  nomeCidade.innerText = local;
  lat = c.latitude;
  lon = c.longitude;
  paisSelecionado = c.country_code; 
  lista.innerHTML = "";

  limparTela();
  buscar();
};

  lista.appendChild(div);
 });
});

/* =========================
   ENTER SELECIONA PRIMEIRO
========================= */
cidade.addEventListener("keydown",e=>{
 if(e.key==="Enter"){
  const item = lista.querySelector("div");
  if(item) item.click();
 }
});

/* =========================
   BUSCA PRINCIPAL
========================= */
async function buscar(){
 if(lat===null || lon===null){
  info.innerHTML="üìç Selecione a cidade na lista";
  return;
 }

  /* ===== API ATUAL ===== */
 const rAtual = await fetch(
  `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
  `&current_weather=true` +
  `&hourly=apparent_temperature,relativehumidity_2m,pressure_msl,precipitation,precipitation_probability,visibility,cloudcover,windspeed_10m` +
  `&daily=sunrise,sunset,temperature_2m_min,temperature_2m_max,precipitation_sum,precipitation_probability_max,uv_index_max` +
  `&timezone=auto`
 );
 const atual = await rAtual.json();

 /* ===== API QUALIDADE DO AR ===== */
 const rAQ = await fetch(
  `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5,pm10,european_aqi&timezone=auto`
 );
 const aq = await rAQ.json();

 /* =========================
    √çNDICE HOR√ÅRIO ATUAL
 ========================= */
 const agora = Date.now();
 let idx = 0, min = Infinity;

 atual.hourly.time.forEach((t,i)=>{
  const d = Math.abs(new Date(t).getTime() - agora);
  if(d < min){ min = d; idx = i; }
 });

 let idxAQ = 0, minAQ = Infinity;
 aq.hourly.time.forEach((t,i)=>{
  const d = Math.abs(new Date(t).getTime() - agora);
  if(d < minAQ){ minAQ = d; idxAQ = i; }
 });

/* =========================
   PR√ìXIMA CHUVA
========================= */
let proximaChuva = "‚Äî";
let probChuva = 0;
let idxChuva = -1; // √≠ndice da pr√≥xima chuva

for(let i = idx; i < atual.hourly.time.length; i++){
  const mm = atual.hourly.precipitation?.[i] ?? 0;
  const prob = atual.hourly.precipitation_probability?.[i] ?? 0;

  if(mm > 0 || prob >= 20){
    proximaChuva = atual.hourly.time[i].slice(11,16); // ainda mantemos hora para compatibilidade
    probChuva = prob;
    idxChuva = i; // guarda o √≠ndice
    break;
  }
}

 /* =========================
    UV
 ========================= */
 const uvIndex = atual.daily.uv_index_max?.[0] ?? 0;
 const {classe, descricao} = formatarUV(uvIndex);

 info.innerHTML = `
  <span style="font-size:13px">
   üå°Ô∏è <b>${atual.current_weather.temperature}¬∞C</b> ‚Ä¢ 
   Sensa√ß√£o: ${atual.hourly.apparent_temperature[idx]}¬∞C ‚Ä¢ 
   ‚òÄÔ∏è UV: <b class="${classe}">${uvIndex}</b> (${descricao})
  </span>`;
  
  /* =========================
   QUALIDADE DO AR (AQI)
========================= */
let usAQI = 0;

if (aq?.hourly?.pm2_5?.length && typeof idxAQ === "number") {
  const pm25 = aq.hourly.pm2_5[idxAQ] ?? 0;
  usAQI = pm25ToUSAQI(pm25);
}
  
/* =========================
   PRESS√ÉO ATMOSF√âRICA (ATUAL REAL)
========================= */
let pressaoExibir = "‚Äî";

// prioridade m√°xima: valor atual real
if (typeof atual?.current_weather?.pressure_msl === "number") {
  pressaoExibir = atual.current_weather.pressure_msl;
}
// fallback apenas se n√£o existir
else if (typeof atual?.hourly?.pressure_msl?.[idx] === "number") {
  pressaoExibir = atual.hourly.pressure_msl[idx];
}
let pressaoExibir_masc = atual.hourly.pressure_msl[idx] + 3.1;
linhaPressao.innerHTML =
  `üå¨Ô∏è Press√£o: <b>${pressaoExibir_masc.toFixed(1)} hPa</b> ‚Ä¢ ` +
  `üå´Ô∏è Qual. Ar: ${formatarAQ(usAQI)}`;
  

 /* =========================
    VISIBILIDADE (VALOR V√ÅLIDO)
 ========================= */
 let vis = null;

 for(let i = idx; i < atual.hourly.visibility.length; i++){
  const v = atual.hourly.visibility[i];
  if(v != null && v <= 30000){ vis = v; break; }
 }
 if(vis === null){
  for(let i = idx-1; i >= 0; i--){
   const v = atual.hourly.visibility[i];
   if(v != null && v <= 30000){ vis = v; break; }
  }
 }

 const visibilidade = vis != null ? (vis/1600).toFixed(2) : "‚Äî";

 /* =========================
    DIRE√á√ÉO DO VENTO
 ========================= */
 const deg = atual.current_weather.winddirection ?? null;

 function degParaDirecao(d){
  if(d==null) return "‚Äî";
  const dirs = [
   "Norte","Norte-Nordeste","Nordeste","Leste-Nordeste",
   "Leste","Leste-Sudeste","Sudeste","Sul-Sudeste",
   "Sul","Sul-Sudoeste","Sudoeste","Oeste-Sudoeste",
   "Oeste","Oeste-Noroeste","Noroeste","Norte-Noroeste"
  ];
  return dirs[Math.round(d/22.5) % 16];
 }

 const direcaoVento = degParaDirecao(deg);

 linhaVisibilidade.innerHTML =
  `üëÅÔ∏è Visib.: <b>${visibilidade} km</b> ‚Ä¢ ` +
  `üí® Vento: <b>${atual.current_weather.windspeed} km/h</b> ` +
  `(<b>${direcaoVento}</b>)`;

/* =========================
    RAJADAS DE VENTO (ADICIONADO)
 ========================= */
 let rajadas = "‚Äî";
 if(atual.hourly.windspeed_10m?.[idx] != null){
  rajadas = (atual.hourly.windspeed_10m[idx] * 1.6).toFixed(1);
 }

/* =========================
    NEVOEIRO + RAJADAS (CORRIGIDO)
 ========================= */
let nevoeiro = "Ausente üå§Ô∏è";

// nevoeiro pela visibilidade (em METROS)
if(vis !== null){
  if(vis <= 1000){
    nevoeiro = "Nevoeiro Denso ";
  }
  else if(vis <= 2000){
    nevoeiro = "Nevoeiro Fraco ";
  }
}

// confirma√ß√£o por umidade + vento (Chapec√≥-style üòÑ)
const umid = atual.hourly.relativehumidity_2m[idx];
const vento = atual.current_weather.windspeed;

if(vis !== null && umid >= 84 && vento <= 4){
  nevoeiro = "Nevoeiros Esparsos ";
}

linhaNevoeiro.innerHTML =
 `üå´Ô∏è Nevoeiro: <b>${nevoeiro}</b> ‚Ä¢ üå¨Ô∏èRajadas: <b>${rajadas} km/h</b>`;

 /* =========================
    UMIDADE / CHUVA / NEBULOSIDADE
 ========================= */
 const chuvaHora = atual.hourly.precipitation_probability?.[idx] ?? 0;

 let neb = null;
 for(let i = idx; i < atual.hourly.cloudcover.length; i++){
  const v = atual.hourly.cloudcover[i];
  if(v != null && v >= 0 && v <= 100){ neb = v; break; }
 }
 if(neb === null){
  for(let i = idx-1; i >= 0; i--){
   const v = atual.hourly.cloudcover[i];
   if(v != null && v >= 0 && v <= 100){ neb = v; break; }
  }
 }

 const nebulosidade = neb !== null ? neb : "‚Äî";

 linhaUmidade.innerHTML =
  `üíßUmidade: <b>${atual.hourly.relativehumidity_2m[idx]}%</b> ‚Ä¢ ` +
  `üåßÔ∏èChuva: <b class="${formatarChuvaClasse(chuvaHora)}">${chuvaHora}%</b> ‚Ä¢ ` +
  `‚òÅÔ∏èNebulosidade: <b>${nebulosidade}%</b>`;
 
montarPainelClimatico({
  atual,
  idx,
  idxChuva,
  probChuva,
  pais: paisSelecionado,   
  estado: cidade.value.split("-")[1]?.trim()
});

async function montarPainelClimatico({ atual, idx, idxChuva, probChuva, pais, estado }) {
  
  /* ===== LUA ===== */
  const lua = calcularLua(new Date());
  linhaLua.innerHTML =
    `üåô Lua:<b>${lua.fase}</b> ‚Ä¢ ` +
    `Luar:<b>${lua.iluminacao}%</b> ‚Ä¢ ` +
    `Idade:<b>${lua.idade} dias</b>`;

  /* ===== STATUS BASE ===== */
  definirStatus(
    atual.hourly.pressure_msl[idx],
    atual.hourly.precipitation[idx]
  );

  let statusBase = linhaStatus.innerText;

  /* ===== HORA LOCAL ===== */
  const horaAtualCidade = atual.current_weather?.time?.slice(11, 16) ?? "‚Äî";

  /* ===== CHUVA PREVISTA ===== */
  let chuvaTexto = "";
  if (Number.isInteger(idxChuva) && idxChuva >= 0) {
    const t = new Date(atual.hourly.time[idxChuva]);
    const dataHora =
      `${String(t.getDate()).padStart(2,"0")}/` +
      `${String(t.getMonth()+1).padStart(2,"0")}-` +
      `${String(t.getHours()).padStart(2,"0")}:` +
      `${String(t.getMinutes()).padStart(2,"0")} hs`;

    chuvaTexto = ` ‚Ä¢ üåßÔ∏è Chuva prevista: <b>${dataHora} (${probChuva}%)</b>`;
  }

const oni = -0.6;   // ‚Üê CONTROLE TOTAL AQUI

let fenomeno = "Neutro";
let valor = oni;

if (oni >= 0.5) fenomeno = "El Ni√±o";
else if (oni <= -0.5) fenomeno = "La Ni√±a";


/* ===== IMPACTO SOMENTE BRASIL ===== */
let impactoTexto = "";

const paisNorm = (pais || "").toUpperCase().trim();

if (
  paisNorm === "BR" ||
  paisNorm === "BRA" ||
  paisNorm.includes("BRASIL") ||
  paisNorm.includes("BRAZIL")
) {

  const mapaEstados = {
    "RIO GRANDE DO SUL":"RS","SANTA CATARINA":"SC","PARAN√Å":"PR",
    "S√ÉO PAULO":"SP","RIO DE JANEIRO":"RJ","MINAS GERAIS":"MG","ESP√çRITO SANTO":"ES",
    "MATO GROSSO":"MT","MATO GROSSO DO SUL":"MS","GOI√ÅS":"GO","DISTRITO FEDERAL":"DF",
    "BAHIA":"BA","SERGIPE":"SE","ALAGOAS":"AL","PERNAMBUCO":"PE","PARA√çBA":"PB",
    "RIO GRANDE DO NORTE":"RN","CEAR√Å":"CE","PIAU√ç":"PI","MARANH√ÉO":"MA",
    "AMAZONAS":"AM","PAR√Å":"PA","ACRE":"AC","ROND√îNIA":"RO","RORAIMA":"RR",
    "AMAP√Å":"AP","TOCANTINS":"TO"
  };

  let est = estado?.toUpperCase() ?? "";
  est = mapaEstados[est] ?? est;

  const regiaoPorEstado = {
    RS:"Sul",SC:"Sul",PR:"Sul",
    SP:"Sudeste",RJ:"Sudeste",MG:"Sudeste",ES:"Sudeste",
    MT:"Centro-Oeste",MS:"Centro-Oeste",GO:"Centro-Oeste",DF:"Centro-Oeste",
    BA:"Nordeste",SE:"Nordeste",AL:"Nordeste",PE:"Nordeste",PB:"Nordeste",
    RN:"Nordeste",CE:"Nordeste",PI:"Nordeste",MA:"Nordeste",
    AM:"Norte",PA:"Norte",AC:"Norte",RO:"Norte",RR:"Norte",AP:"Norte",TO:"Norte"
  };

  const impacto = {
    Sul:{
      "El Ni√±o":"Chuvas acima da m√©dia e temporais",
      "La Ni√±a":"Frio intenso e tempo mais seco",
      "Neutro":"Clima pr√≥ximo do normal"
    },
    Sudeste:{
      "El Ni√±o":"Calor forte e chuva irregular",
      "La Ni√±a":"Ver√µes mais chuvosos",
      "Neutro":"Padr√£o t√≠pico"
    },
    "Centro-Oeste":{
      "El Ni√±o":"Calor e chuva mal distribu√≠da",
      "La Ni√±a":"Chuvas mais constantes",
      "Neutro":"Condi√ß√µes normais"
    },
    Nordeste:{
      "El Ni√±o":"Tend√™ncia a seca",
      "La Ni√±a":"Mais epis√≥dios de chuva",
      "Neutro":"Vari√°vel"
    },
    Norte:{
      "El Ni√±o":"Menos chuva na Amaz√¥nia",
      "La Ni√±a":"Chuvas acima da m√©dia",
      "Neutro":"Regime normal"
    }
  };

  const regiao = regiaoPorEstado[est];
  if (regiao && impacto[regiao]?.[fenomeno]) {
    impactoTexto = ` ‚Ä¢ üìç Impacto no ${regiao}: ${impacto[regiao][fenomeno]}`;
  }
}

  /* ===== ATUALIZA LINHA STATUS FINAL ===== */
linhaStatus.innerHTML = `
  <div>üïí Hora Local Coleta: ${horaAtualCidade}</div>
  ${chuvaTexto ? `<div>${chuvaTexto}</div>` : ""}
  <div>üåä Fen√¥meno: <b>${fenomeno}</b>${valor !== null ? ` (${valor.toFixed(1)})` : ""}</div>
  ${impactoTexto ? `<div>${impactoTexto}</div>` : ""}
`;
}
 /* =========================
    LINHA DO SOL
 ========================= */
 montarLinhaSol(atual.daily);
 montarPrevisao5Dias(atual.daily);
 montarGraficoPrevisao(atual.daily);

 /* =========================
    HIST√ìRICO (30 DIAS)
 ========================= */
 const hoje = new Date();
 const ontem = new Date(hoje); ontem.setDate(hoje.getDate()-1);
 const ini = new Date(ontem); ini.setDate(ontem.getDate()-30);

 const rHist = await fetch(
  `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}` +
  `&start_date=${ini.toISOString().split("T")[0]}` +
  `&end_date=${ontem.toISOString().split("T")[0]}` +
  `&hourly=pressure_msl,precipitation&timezone=UTC`
 );
 const hist = await rHist.json();
 histSalvo = hist.hourly;

 calcularPressaoChuva(hist.hourly);
 montarGrafico(hist.hourly);
 buscarTemperaturasMensais();
}

/* =========================
   PM2.5 ‚Üí US AQI
========================= */
function pm25ToUSAQI(pm25){
 if(pm25<=12) return Math.round((50/12)*pm25);
 if(pm25<=35.4) return Math.round(((100-51)/(35.4-12.1))*(pm25-12.1)+51);
 if(pm25<=55.4) return Math.round(((150-101)/(55.4-35.5))*(pm25-35.5)+101);
 if(pm25<=150.4) return Math.round(((200-151)/(150.4-55.5))*(pm25-55.5)+151);
 if(pm25<=250.4) return Math.round(((300-201)/(250.4-150.5))*(pm25-150.5)+201);
 if(pm25<=350.4) return Math.round(((400-301)/(350.4-250.5))*(pm25-250.5)+301);
 if(pm25<=500.4) return Math.round(((500-401)/(500.4-350.5))*(pm25-350.5)+401);
 return 500;
}

/* =========================
   HIST√ìRICO MENSAL (12 MESES)
========================= */

async function buscarTemperaturasMensais(){
  const hoje = new Date();
  const inicio = new Date(hoje.getFullYear()-1, hoje.getMonth(), 1);

  const r = await fetch(
    `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}` +
    `&start_date=${inicio.toISOString().split("T")[0]}` +
    `&end_date=${hoje.toISOString().split("T")[0]}` +
    `&daily=temperature_2m_min,temperature_2m_max,temperature_2m_mean` +
    `&timezone=auto`
  );

  const d = await r.json();
  if(!d?.daily?.time) return;

  const meses = {};

  d.daily.time.forEach((t,i)=>{
    const m = t.slice(0,7); // YYYY-MM
    meses[m] ??= {min:[], max:[], med:[]};

    meses[m].min.push(d.daily.temperature_2m_min[i]);
    meses[m].max.push(d.daily.temperature_2m_max[i]);
    meses[m].med.push(d.daily.temperature_2m_mean[i]);
  });

  const labels = [];
  const min = [];
  const max = [];
  const med = [];

  const nomesMes = [
  "Jan","Fev","Mar","Abr","Mai","Jun",
  "Jul","Ago","Set","Out","Nov","Dez"
];

Object.keys(meses).slice(-12).forEach(m=>{
  const [ano,mes] = m.split("-");

  labels.push(`${nomesMes[Number(mes)-1]}/${ano.slice(2)}`);

  min.push(media(meses[m].min).toFixed(1));
  max.push(media(meses[m].max).toFixed(1));
  med.push(media(meses[m].med).toFixed(1));
});

  montarGraficoMensal(labels, min, med, max);
}

function media(arr){
  return arr.reduce((a,b)=>a+b,0) / arr.length;
}

function montarGraficoMensal(labels, min, med, max){
  chartMensal?.destroy();

  chartMensal = new Chart(
    document.getElementById("graficoMensal"),
    {
      type:"line",
      data:{
        labels,
        datasets:[
          {
            label:"M√≠nima(¬∞C)",
            data:min,
            tension:.35,
            borderWidth:2,
            pointRadius:4
          },
          {
            label:"M√©dia(¬∞C)",
            data:med,
            tension:.35,
            borderWidth:3,
            pointRadius:4
          },
          {
            label:"M√°xima(¬∞C)",
            data:max,
            tension:.35,
            borderWidth:2,
            pointRadius:4
          }
        ]
      },
      options:{
        plugins:{
          title:{
            display:true,
            text:"Temperatura Mensal - √∫ltimos 12 Meses ‚Äî M√≠n., M√©dia e M√°x.",
            font:{size:13, weight:"bold"},
            color:document.body.classList.contains("dark") ? "#e6edf3" : "#000"
          }
        },
        scales: {
          x: {
            ticks: {
              color: "#006400", // verde escuro
              font: {
                size: 12,
                weight: "bold"
              }
            }
          },
          y: {
            ticks: {
              color: "#006400" // opcional: se quiser o eixo Y tamb√©m verde escuro
            }
          }
        }
      }
    }
  );
}


/* =========================
   FORMATADORES
========================= */
function formatarAQ(v){
 if(v<=50) return `<span class="aq-bom">Boa (${v})</span>`;
 if(v<=100) return `<span class="aq-mod">Moderada (${v})</span>`;
 if(v<=150) return `<span class="aq-ruim">Insalubre (${v})</span>`;
 if(v<=200) return `<span class="aq-muito">Muito Insalub. (${v})</span>`;
 if(v<=300) return `<span class="aq-severo">Severo (${v})</span>`;
 return `<span class="aq-extremo">Extrema (${v})</span>`;
}

function formatarUV(v){
 let classe="",descricao="";
 if(v<=2){classe="aq-bom";descricao="Baixo";}
 else if(v<=5){classe="aq-mod";descricao="M√©dio";}
 else if(v<=7){classe="aq-ruim";descricao="Alto";}
 else if(v<=10){classe="aq-muito";descricao="Muito Alto";}
 else{classe="aq-extremo";descricao="Extremo";}
 return {classe,descricao};
}

/* =========================
   LUA
========================= */
function calcularLua(data){
  const ref = new Date(Date.UTC(2000, 0, 6, 18, 14, 0));
  const ciclo = 29.530588853;

  const dias = (data.getTime() - ref.getTime()) / 86400000;
  const idade = ((dias % ciclo) + ciclo) % ciclo;
  const frac = idade / ciclo;

  const iluminacao = Math.round(
    (1 - Math.cos(2 * Math.PI * frac)) / 2 * 100
  );

  let fase = "";

  if (idade < 1.84566) fase = "Lua Nova üåë";
  else if (idade < 5.53699) fase = "Lua Crescente üåí";
  else if (idade < 9.22831) fase = "Quarto Crescente üåì";
  else if (idade < 12.91963) fase = "Crescente Gibosa üåî";
  else if (idade < 16.61096) fase = "Lua Cheia üåï";
  else if (idade < 20.30228) fase = "Minguante Gibosa üåñ";
  else if (idade < 23.99361) fase = "Quarto Minguante üåó";
  else if (idade < 27.68493) fase = "Lua Minguante üåò";
  else fase = "Lua Nova üåë";

  return {
    fase,
    iluminacao,
    idade: idade.toFixed(1)
  };
}

function formatarChuvaClasse(v){
 if(v<=20) return "chuva-bom";
 if(v<=40) return "chuva-mod";
 if(v<=60) return "chuva-ruim";
 if(v<=80) return "chuva-muito";
 return "chuva-extremo";
}


/* =========================
   STATUS
========================= */
function definirStatus(p,c){
 linhaStatus.className="linha-status";
 if(c>8||p<1005){
  linhaStatus.classList.add("tempestade");
  linhaStatus.innerText="‚õàÔ∏èTempo:Risco de Tempestade";
 }
 else if(c>1||p<1012){
  linhaStatus.classList.add("chuva");
  linhaStatus.innerText="üåßÔ∏è Tempo:Possibilidade de chuva";
 }
 else{
  linhaStatus.classList.add("bom");
  linhaStatus.innerText="‚òÄÔ∏èTempo: Tempo bom";
 }
}

/* =========================
   SOL
========================= */
function montarLinhaSol(d){
 if(!d?.time) return;
 const diasSemana=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
 linhaSol.innerHTML="";
 for(let i=0;i<4;i++){
  const p=d.time[i].split("-");
  const data=new Date(p[0],p[1]-1,p[2]);
  linhaSol.innerHTML+=`
   <div class="sol-dia">
    ${p[2]}/${p[1]}<br>
    ${diasSemana[data.getDay()]}<br>
    üåÖ ${d.sunrise[i].slice(11,16)}<br>
    üåá ${d.sunset[i].slice(11,16)}
   </div>`;
 }
}

/* =========================
   PREVIS√ÉO 5 DIAS
========================= */
function montarPrevisao5Dias(d){
 if(!d?.time) return;
 const diasSemana=["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
 previsao5.innerHTML="";
 for(let i=0;i<5;i++){
  const p=d.time[i].split("-");
  const data=new Date(p[0],p[1]-1,p[2]);
  previsao5.innerHTML+=`
   <div class="previsao-dia">
    ${p[2]}/${p[1]}<br>
    ${diasSemana[data.getDay()]}<br>
    üåßÔ∏è ${d.precipitation_sum[i]}mm (${d.precipitation_probability_max[i]}%)<br>
    ${d.temperature_2m_min[i]}¬∞ / ${d.temperature_2m_max[i]}¬∞
   </div>`;
 }
}

/* =========================
   PRESS√ÉO √ó CHUVA
========================= */
function calcularPressaoChuva(h){
 if(!h?.time) return;
 const dias={};
 h.time.forEach((t,i)=>{
  const d=t.split("T")[0];
  dias[d]??={p:[],mm:0};
  dias[d].p.push(h.pressure_msl[i]);
  dias[d].mm+=h.precipitation[i];
 });
 const press=[];
 Object.values(dias).forEach(d=>{
  if(d.mm>=1) press.push(d.p.reduce((a,b)=>a+b)/d.p.length);
 });
 if(press.length<3){
  linhaAviso.innerHTML="üåßÔ∏è Dados insuficientes para padr√£o confi√°vel.";
  return;
 }
 const m=press.reduce((a,b)=>a+b)/press.length;
 linhaAviso.innerHTML=`üåßÔ∏è Chove geralmente com press√£o m√©dia de <b>${m.toFixed(1)} hPa</b>`;
}

/* =========================
   GR√ÅFICOS
========================= */
function montarGraficoPrevisao(d){
 chartPrevisao?.destroy();
 chartPrevisao=new Chart(
  document.getElementById("graficoPrevisao"),{
   data:{
    labels:d.time.map(t=>t.slice(8,10)+"/"+t.slice(5,7)),
    datasets:[
     {type:"bar",label:"Chuva (mm)",data:d.precipitation_sum},
     {type:"bar",label:"Prob. chuva (%)",data:d.precipitation_probability_max},
     {type:"line",label:"Temp Min (¬∞C)",data:d.temperature_2m_min},
     {type:"line",label:"Temp Max (¬∞C)",data:d.temperature_2m_max}
    ]
   },
   options:{
    plugins:{
     title:{
      display:true,
      text:"Previs√£o de Chuva e Temperatura ‚Äî 7 dias",
      font:{size:12,weight:"bold"},
      color:document.body.classList.contains("dark")?"#e6edf3":"#000"
     }
    }
   }
  }
 );
}

function montarGrafico(h){
 if(!h?.time) return;

 const dias={}, chuva={};

 h.time.forEach((t,i)=>{
  const d=t.split("T")[0];
  dias[d] ??= [];
  dias[d].push(h.pressure_msl[i]);
  chuva[d]=(chuva[d]||0)+h.precipitation[i];
 });

 const labels=[], press=[], mm=[];
 Object.keys(dias).slice(-5).forEach(d=>{
  const p=d.split("-");
  labels.push(`${p[2]}/${p[1]}`);
  press.push((dias[d].reduce((a,b)=>a+b)/dias[d].length).toFixed(1));
  mm.push(chuva[d].toFixed(1));
 });

 chart?.destroy();
 chart=new Chart(
  document.getElementById("grafico"),{
   data:{
    labels,
    datasets:[
     {type:"line",label:"Press√£o M√©dia (hPa)",data:press,borderWidth:2,tension:.3},
     {type:"bar",label:"Chuva Acumulada (mm)",data:mm,yAxisID:"y1"}
    ]
   },
   options:{
    plugins:{
     title:{
      display:true,
      text:"Press√£o Atmosf√©rica √ó Chuva ‚Äî √öltimos 5 dias",
      font:{size:12,weight:"bold"},
      color:document.body.classList.contains("dark")?"#e6edf3":"#000"
     }
    },
    scales:{
     y:{title:{display:true,text:"Press√£o (hPa)"}},
     y1:{
      position:"right",
      beginAtZero:true,
      grid:{drawOnChartArea:false},
      title:{display:true,text:"Chuva (mm)"}
     }
    }
   }
  }
 );
}

/* =========================
   GEOLOCALIZA√á√ÉO INICIAL
========================= */
navigator.geolocation?.getCurrentPosition(p=>{
 lat=p.coords.latitude;
 lon=p.coords.longitude;
 nomeCidade.innerText="Sua localiza√ß√£o";
 buscar();
});
</script>
</body>
</html>
