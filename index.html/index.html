<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & PressÃ£o AtmosfÃ©rica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
 --bg1:#1565c0;
 --bg2:#26c6da;
 --card:rgba(255,255,255,.18);
 --text:#fff;
 --grafico:#ffffff;
}

body.dark{
 --bg1:#0d1117;
 --bg2:#161b22;
 --card:rgba(255,255,255,.08);
 --text:#e6edf3;
 --grafico:#0d1117;
}

body{
 margin:0;
 font-family:Arial,sans-serif;
 background:linear-gradient(135deg,var(--bg1),var(--bg2));
 color:var(--text);
 padding:16px;
 transition:.3s;
}

header{
 display:flex;
 justify-content:space-between;
 align-items:center;
 margin-bottom:10px;
}

h2{
 font-size:18px;
 font-weight:normal;
 margin:0;
}

h2 span{
 font-weight:bold;
}

button.toggle{
 background:rgba(255,255,255,.25);
 border:none;
 border-radius:50px;
 padding:6px 12px;
 font-size:16px;
 cursor:pointer;
 color:var(--text);
}

.card{
 background:var(--card);
 border-radius:16px;
 padding:16px;
 margin-bottom:16px;
}

input{
 width:100%;
 padding:12px;
 margin-top:8px;
 border:none;
 border-radius:10px;
 font-size:16px;
}

.autocomplete{
 background:#fff;
 color:#000;
 border-radius:10px;
 margin-top:4px;
 overflow:hidden;
 position:absolute;
 z-index:10;
 width:calc(100% - 32px);
}

.autocomplete div{padding:10px;cursor:pointer;}
.autocomplete div:hover{background:#e0e0e0;}

.linha-info{margin-top:6px;font-size:14px;}
.linha-status{margin-top:10px;font-size:15px;font-weight:bold;padding:8px;border-radius:10px;}
.bom{background:#2e7d32;}
.chuva{background:#f9a825;color:#000;}
.tempestade{background:#c62828;}

#linha-sol{display:flex;gap:8px;margin-top:12px;}
.sol-dia{
 flex:1;
 background:#1a237e;
 border-radius:10px;
 padding:8px;
 height:80px;
 display:flex;
 flex-direction:column;
 justify-content:center;
 align-items:center;
 font-size:13px;
 font-weight:bold;
}

body.dark .sol-dia{background:#0b3c5d;}

#previsao-5dias{
 display:flex;
 gap:6px;
 margin-top:8px;
 overflow-x:auto;
}

.previsao-dia{
 background:rgba(255,255,255,.18);
 border-radius:10px;
 padding:6px;
 min-width:90px;
 text-align:center;
 font-size:12px;
 font-weight:bold;
}

canvas{
 background:var(--grafico);
 border-radius:10px;
 padding:8px;
}
</style>
</head>

<body>

<header>
 <h2>ğŸŒ¡ï¸ Clima em: <span id="nome-cidade"></span></h2>
 <button class="toggle" id="toggleModo">ğŸŒ™</button>
</header>

<div class="card">
 <input id="cidade" placeholder="Digite a cidade">
 <div id="lista" class="autocomplete"></div>

 <div id="info"></div>
 <div id="linha-pressao" class="linha-info"></div>
 <div id="linha-umidade" class="linha-info"></div>
 <div id="linha-status" class="linha-status"></div>
 <div id="linha-aviso" class="linha-info"></div>

 <div id="linha-sol"></div>
 <div id="previsao-5dias"></div>
</div>

<div class="card">
 <canvas id="grafico"></canvas>
</div>

<script>
let lat=null,lon=null,chart=null,ultimoHist=null;

const cidade=document.getElementById("cidade"),
lista=document.getElementById("lista"),
nomeCidade=document.getElementById("nome-cidade"),
info=document.getElementById("info"),
linhaPressao=document.getElementById("linha-pressao"),
linhaUmidade=document.getElementById("linha-umidade"),
linhaStatus=document.getElementById("linha-status"),
linhaAviso=document.getElementById("linha-aviso"),
linhaSol=document.getElementById("linha-sol"),
previsao5=document.getElementById("previsao-5dias"),
btnModo=document.getElementById("toggleModo");

/* ===== MODO NOTURNO ===== */
function aplicarModo(m){
 document.body.classList.toggle("dark",m==="dark");
 btnModo.textContent=m==="dark"?"â˜€ï¸":"ğŸŒ™";
 localStorage.setItem("modo",m);
 if(ultimoHist) montarGrafico(ultimoHist);
}

function modoAuto(){
 const h=new Date().getHours();
 const sys=matchMedia("(prefers-color-scheme: dark)").matches;
 return (h>=18||h<=6||sys)?"dark":"light";
}

aplicarModo(localStorage.getItem("modo")||modoAuto());
btnModo.onclick=()=>aplicarModo(document.body.classList.contains("dark")?"light":"dark");

/* ===== LIMPAR AO CLICAR ===== */
cidade.addEventListener("focus",()=>{
 cidade.value="";
 lista.innerHTML="";
});

/* ===== AUTOCOMPLETE ===== */
cidade.addEventListener("input",async()=>{
 lista.innerHTML="";
 if(cidade.value.length<2) return;

 const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cidade.value)}&count=5&language=pt`);
 const d=await r.json();
 if(!d.results) return;

 d.results.forEach(c=>{
  const nome=`${c.name} - ${c.admin1||c.country}`;
  const div=document.createElement("div");
  div.innerText=nome;
  div.onclick=()=>{
   cidade.value=nome;
   nomeCidade.innerText=nome;
   lat=c.latitude; lon=c.longitude;
   lista.innerHTML="";
   buscar();
  };
  lista.appendChild(div);
 });
});

/* ===== BUSCA ===== */
async function buscar(){
 const rAtual=await fetch(
  `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=apparent_temperature,relativehumidity_2m,pressure_msl,precipitation&daily=sunrise,sunset,temperature_2m_min,temperature_2m_max,precipitation_sum,precipitation_probability_max&timezone=auto`
 );
 const atual=await rAtual.json();

 const agora=Date.now();
 let idx=0,min=Infinity;
 atual.hourly.time.forEach((t,i)=>{
  const d=Math.abs(new Date(t).getTime()-agora);
  if(d<min){min=d;idx=i;}
 });

 info.innerHTML=`ğŸŒ¡ï¸ <b>${atual.current_weather.temperature}Â°C</b> â€¢ SensaÃ§Ã£o ${atual.hourly.apparent_temperature[idx]}Â°C`;
 linhaPressao.innerHTML=`ğŸŒ¬ï¸ PressÃ£o: <b>${atual.hourly.pressure_msl[idx]} hPa</b>`;
 linhaUmidade.innerHTML=`ğŸ’§ Umidade: <b>${atual.hourly.relativehumidity_2m[idx]}%</b> â€¢ ğŸ’¨ Vento: <b>${atual.current_weather.windspeed} km/h</b>`;

 definirStatus(atual.hourly.pressure_msl[idx],atual.hourly.precipitation[idx]);
 montarLinhaSol(atual.daily);
 montarPrevisao5Dias(atual.daily);

 const hoje=new Date();
 const ini=new Date(); ini.setDate(hoje.getDate()-30);

 const rHist=await fetch(
  `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${ini.toISOString().split("T")[0]}&end_date=${hoje.toISOString().split("T")[0]}&hourly=pressure_msl,precipitation&timezone=auto`
 );
 const hist=await rHist.json();
 ultimoHist=hist.hourly;

 calcularPressaoChuva(hist.hourly);
 montarGrafico(hist.hourly);
}

/* ===== FUNÃ‡Ã•ES AUX ===== */
function definirStatus(p,c){
 linhaStatus.className="linha-status";
 if(c>8||p<1005){linhaStatus.classList.add("tempestade");linhaStatus.innerText="â›ˆï¸ Risco de tempestade";}
 else if(c>1||p<1012){linhaStatus.classList.add("chuva");linhaStatus.innerText="ğŸŒ§ï¸ Possibilidade de chuva";}
 else{linhaStatus.classList.add("bom");linhaStatus.innerText="â˜€ï¸ Tempo bom";}
}

function calcularPressaoChuva(h){
 let p=[];
 h.precipitation.forEach((v,i)=>v>=0.3&&p.push(h.pressure_msl[i]));
 linhaAviso.innerHTML=p.length
 ? `ğŸŒ§ï¸ Normalmente chove abaixo de <b>${p.sort((a,b)=>a-b)[Math.floor(p.length/2)].toFixed(1)} hPa</b>.`
 : "ğŸŒ§ï¸ Normalmente chove abaixo de <b>1013 hPa</b>.";
}

function montarLinhaSol(d){
 linhaSol.innerHTML="";
 for(let i=0;i<4;i++){
  linhaSol.innerHTML+=`
  <div class="sol-dia">
   ${d.time[i].split("-").reverse().join("/")}<br>
   ğŸŒ… ${d.sunrise[i].slice(11,16)}<br>
   ğŸŒ‡ ${d.sunset[i].slice(11,16)}
  </div>`;
 }
}

function montarPrevisao5Dias(d){
 previsao5.innerHTML="";
 for(let i=0;i<5;i++){
  previsao5.innerHTML+=`
  <div class="previsao-dia">
   ${d.time[i].split("-").reverse().join("/")}<br>
   ğŸŒ§ï¸ ${d.precipitation_sum[i]} mm â€¢ ${d.precipitation_probability_max[i]}%<br>
   ${d.temperature_2m_min[i]}Â° / ${d.temperature_2m_max[i]}Â°
  </div>`;
 }
}

function montarGrafico(h){
 const dias={},mm={};
 h.time.forEach((t,i)=>{
  const d=t.split("T")[0];
  dias[d]??=[];
  mm[d]=(mm[d]||0)+h.precipitation[i];
  dias[d].push(h.pressure_msl[i]);
 });

 const labels=[],pressao=[],chuva=[];
 Object.keys(dias).slice(-5).forEach(d=>{
  labels.push(d.split("-").reverse().join("/"));
  pressao.push((dias[d].reduce((a,b)=>a+b)/dias[d].length).toFixed(1));
  chuva.push(mm[d].toFixed(1));
 });

 chart?.destroy();
 chart=new Chart(document.getElementById("grafico"),{
  data:{
   labels,
   datasets:[
    {type:"bar",label:"Chuva (mm)",data:chuva,backgroundColor:"rgba(66,165,245,.6)",yAxisID:"y1"},
    {type:"line",label:"PressÃ£o (hPa)",data:pressao,borderColor:"#ffeb3b",borderWidth:3,tension:.4,yAxisID:"y"}
   ]
  },
  options:{
   plugins:{legend:{onClick:(e,i,l)=>{l.chart.toggleDataVisibility(i.datasetIndex);l.chart.update();}}},
   scales:{
    y:{title:{display:true,text:"PressÃ£o (hPa)"}},
    y1:{position:"right",title:{display:true,text:"Chuva (mm)"},beginAtZero:true,grid:{drawOnChartArea:false}}
   }
  }
 });
}

navigator.geolocation?.getCurrentPosition(p=>{
 lat=p.coords.latitude;
 lon=p.coords.longitude;
 nomeCidade.innerText="Sua localizaÃ§Ã£o";
 buscar();
});
</script>
</body>
</html>
