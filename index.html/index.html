<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & Press√£o Atmosf√©rica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:linear-gradient(135deg,#1565c0,#26c6da);color:#fff;padding:16px;}
h2{text-align:center;font-size:24px;}
.card{background:rgba(255,255,255,.18);border-radius:16px;padding:16px;margin-bottom:16px;}

input,button{width:100%;padding:12px;margin-top:8px;border:none;border-radius:10px;font-size:16px;}
button{background:#00e676;font-weight:bold;cursor:pointer;}

.autocomplete{background:#fff;color:#000;border-radius:10px;margin-top:4px;overflow:hidden;}
.autocomplete div{padding:10px;cursor:pointer;}
.autocomplete div:hover{background:#e0e0e0;}

.linha-info{margin-top:6px;font-size:14px;}
.linha-status{margin-top:10px;font-size:15px;font-weight:bold;padding:8px;border-radius:10px;}
.bom{background:#2e7d32;}
.chuva{background:#f9a825;color:#000;}
.tempestade{background:#c62828;}

#linha-sol{display:flex;gap:8px;margin-top:12px;}
.sol-dia{
  flex:1;
  background:#1a237e;
  border-radius:10px;
  padding:8px;
  height:80px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  font-weight:bold;
}
.sol-data{font-size:13px;margin-bottom:6px;}

#previsao-5dias{display:flex;gap:6px;margin-top:8px;overflow-x:auto;}
.previsao-dia{
  flex:0 0 auto;
  background:rgba(255,255,255,.18);
  border-radius:10px;
  padding:6px;
  min-width:90px;
  text-align:center;
  font-weight:bold;
  font-size:12px;
}
.previsao-dia .icon{font-size:18px;margin:2px 0;}
.previsao-dia .chuva{font-size:11px;color:#fff;}

canvas{background:#fff;border-radius:10px;padding:8px;}
</style>
</head>

<body>

<h2>üå¶Ô∏è <span id="titulo-clima">Clima em:</span> <span id="nome-cidade"></span></h2>

<div class="card">
<input id="cidade" placeholder="Digite a cidade">
<div id="lista" class="autocomplete"></div>
<button onclick="buscar()">Consultar</button>

<div id="info"></div>
<div id="linha-pressao" class="linha-info"></div>
<div id="linha-umidade" class="linha-info"></div>
<div id="linha-status" class="linha-status"></div>
<div id="linha-aviso" class="linha-info"></div>

<div id="linha-sol"></div>
<div id="previsao-5dias"></div>
</div>

<div class="card">
<canvas id="grafico"></canvas>
</div>

<script>
let lat=null,lon=null,chart=null;

// elementos
const cidade=document.getElementById("cidade"),
lista=document.getElementById("lista"),
nomeCidade=document.getElementById("nome-cidade"),
tituloClima=document.getElementById("titulo-clima"),
info=document.getElementById("info"),
linhaPressao=document.getElementById("linha-pressao"),
linhaUmidade=document.getElementById("linha-umidade"),
linhaStatus=document.getElementById("linha-status"),
linhaAviso=document.getElementById("linha-aviso"),
linhaSol=document.getElementById("linha-sol"),
previsao5=document.getElementById("previsao-5dias");

// üéØ Ao carregar, pega a localiza√ß√£o atual
window.addEventListener("load",()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      lat=pos.coords.latitude;
      lon=pos.coords.longitude;
      // reverse geocoding para pegar nome da cidade
      const rGeo = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=pt`);
      const geoData = await rGeo.json();
      if(geoData.name){
        nomeCidade.innerText = geoData.name;
        tituloClima.innerText = "Clima em:";
      } else {
        nomeCidade.innerText = "Sua localiza√ß√£o";
      }
      buscar();
    },()=>{console.log("Permiss√£o de localiza√ß√£o negada")});
  }
});

// autocomplete
cidade.addEventListener("input",async()=>{
 lista.innerHTML="";
 if(cidade.value.length<3)return;

 const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${cidade.value}&count=5&language=pt`);
 const d=await r.json();
 if(!d.results)return;

 d.results.forEach(c=>{
  const div=document.createElement("div");
  div.innerText=c.name+(c.admin1?" - "+c.admin1:"");
  div.onclick=()=>{
   cidade.value=c.name;
   lat=c.latitude; lon=c.longitude;
   nomeCidade.innerText = c.name;
   tituloClima.innerText = "Clima em:";
   lista.innerHTML="";
   buscar(); // atualizar dados ap√≥s escolha
  };
  lista.appendChild(div);
 });
});

// üîπ Fun√ß√£o principal
async function buscar(){
 if(!lat||!lon){alert("Selecione a cidade");return;}

 const rAtual=await fetch(
 `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relativehumidity_2m,pressure_msl,precipitation&daily=sunrise,sunset,temperature_2m_min,temperature_2m_max,precipitation_probability_max,precipitation_sum&timezone=auto`
 );
 const atual=await rAtual.json();

 const agora=new Date();
 const idxHora=atual.hourly.time.findIndex(t=>new Date(t).getHours()===agora.getHours());

 const tempAtual = atual.hourly.temperature_2m[idxHora>=0?idxHora:0];
 const pressaoAtual = atual.hourly.pressure_msl[idxHora>=0?idxHora:0];
 const umidadeAtual = atual.hourly.relativehumidity_2m[idxHora>=0?idxHora:0];
 const chuvaAtual = atual.hourly.precipitation[idxHora>=0?idxHora:0];

 info.innerHTML=`üå°Ô∏è Temperatura atual: <b>${tempAtual}¬∞C</b>`;
 linhaPressao.innerHTML=`üå¨Ô∏è Press√£o atual: <b>${pressaoAtual} hPa</b>`;
 linhaUmidade.innerHTML=`üíß Umidade atual: <b>${umidadeAtual}%</b>`;

 definirStatus(pressaoAtual,chuvaAtual);

 linhaAviso.innerHTML=`üåßÔ∏è <b>Costuma chover</b> quando a press√£o atmosf√©rica est√° abaixo de <b>1010 hPa</b>.`;

 montarLinhaSol(atual.daily);
 montarPrevisao5Dias(atual.daily);

 // üìä Gr√°fico √∫ltimos 5 dias
 const hoje=new Date();
 const inicio=new Date(); inicio.setDate(hoje.getDate()-5);

 const rHist=await fetch(
   `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${inicio.toISOString().split("T")[0]}&end_date=${hoje.toISOString().split("T")[0]}&hourly=pressure_msl,precipitation&timezone=auto`
 );
 const hist=await rHist.json();
 montarGrafico(hist.hourly);
}

// define status tempo
function definirStatus(p,c){
 linhaStatus.className="linha-status";
 if(c>8||p<1005){
  linhaStatus.classList.add("tempestade");
  linhaStatus.innerText="‚õàÔ∏è Risco de tempestade";
 } else if(c>1||p<1012){
  linhaStatus.classList.add("chuva");
  linhaStatus.innerText="üåßÔ∏è Possibilidade de chuva";
 } else {
  linhaStatus.classList.add("bom");
  linhaStatus.innerText="‚òÄÔ∏è Tempo bom";
 }
}

// linha nascer/p√¥r do sol
function montarLinhaSol(d){
 linhaSol.innerHTML="";
 for(let i=0;i<4;i++){
  const div=document.createElement("div");
  div.className="sol-dia";
  div.innerHTML=`
   <div class="sol-data">${d.time[i].split("-").reverse().join("/")}</div>
   <div>üåÖ ${d.sunrise[i].slice(11,16)}</div>
   <div>üåá ${d.sunset[i].slice(11,16)}</div>
  `;
  linhaSol.appendChild(div);
 }
}

// linha previs√£o 5 dias
function montarPrevisao5Dias(d){
 previsao5.innerHTML="";
 for(let i=0;i<5;i++){
  const div=document.createElement("div");
  div.className="previsao-dia";
  let icone="‚òÄÔ∏è";
  if(d.precipitation_sum[i]>5) icone="üåßÔ∏è";
  else if(d.precipitation_sum[i]>0) icone="‚õÖ";
  div.innerHTML=`
   ${d.time[i].split("-").reverse().join("/")}<br>
   <div class="icon">${icone} ${d.precipitation_probability_max[i]}%</div>
   <b>${d.temperature_2m_min[i]}¬∞C / ${d.temperature_2m_max[i]}¬∞C</b>
  `;
  previsao5.appendChild(div);
 }
}

// gr√°fico √∫ltimos 5 dias
function montarGrafico(h){
 const dias={},chuvaDia={};
 h.time.forEach((t,i)=>{
  const d=t.split("T")[0];
  if(!dias[d]){dias[d]=[];chuvaDia[d]=0;}
  dias[d].push(h.pressure_msl[i]);
  chuvaDia[d]+=h.precipitation[i];
 });

 const labels=[],pressao=[],fundo=[],cores=[];
 Object.keys(dias).slice(-5).forEach(d=>{
  labels.push(d.split("-").reverse().join("/"));
  const mediaDia=(dias[d].reduce((a,b)=>a+b)/dias[d].length).toFixed(1);
  pressao.push(mediaDia);
  fundo.push(chuvaDia[d]>1?1050:null);
  cores.push(chuvaDia[d]>1?"red":"#1565c0");
 });

 if(chart) chart.destroy();
 chart=new Chart(document.getElementById("grafico"),{
  data:{
   labels,
   datasets:[
    {
     type:"bar",
     label:"Dias de chuva",
     data:fundo,
     backgroundColor:"rgba(255,0,0,0.18)",
     borderWidth:0
    },
    {
     type:"line",
     label:"Press√£o atmosf√©rica (hPa)",
     data:pressao,
     borderColor:"#1565c0",
     borderWidth:3,
     pointRadius:6,
     pointBackgroundColor:cores,
     tension:0.4
    }
   ]
  },
  options:{
   responsive:true,
   plugins:{
    legend:{display:true,position:"bottom"},
    title:{
      display:true,
      text:"Dias de chuva e Press√£o atmosf√©rica (√∫ltimos 5 dias)",
      font:{size:16,fontStyle:"bold"}
    }
   }
  }
 });
}
</script>

</body>
</html>
