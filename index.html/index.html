<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & PressÃ£o AtmosfÃ©rica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:linear-gradient(135deg,#1565c0,#26c6da);color:#fff;padding:16px;}
h2{text-align:center;font-size:24px;}
.card{background:rgba(255,255,255,.18);border-radius:16px;padding:16px;margin-bottom:16px;}
input{width:100%;padding:12px;margin-top:8px;border:none;border-radius:10px;font-size:16px;}
.autocomplete{background:#fff;color:#000;border-radius:10px;margin-top:4px;overflow:hidden;position:absolute;z-index:10;}
.autocomplete div{padding:10px;cursor:pointer;}
.autocomplete div:hover{background:#e0e0e0;}
.linha-info{margin-top:6px;font-size:14px;}
.linha-status{margin-top:10px;font-size:15px;font-weight:bold;padding:8px;border-radius:10px;}
.bom{background:#2e7d32;}
.chuva{background:#f9a825;color:#000;}
.tempestade{background:#c62828;}
#linha-sol{display:flex;gap:8px;margin-top:12px;}
.sol-dia{flex:1;background:#1a237e;border-radius:10px;padding:8px;height:80px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;font-weight:bold;}
.sol-data{font-size:13px;margin-bottom:6px;}
#previsao-5dias{display:flex;gap:6px;margin-top:8px;overflow-x:auto;}
.previsao-dia{flex:0 0 auto;background:rgba(255,255,255,.18);border-radius:10px;padding:6px;min-width:90px;text-align:center;font-weight:bold;font-size:12px;}
canvas{background:#fff;border-radius:10px;padding:8px;}
</style>
</head>

<body>

<h2>ğŸŒ¡ï¸ Clima em: <span id="nome-cidade"></span></h2>

<div class="card">
<input id="cidade" placeholder="Digite a cidade">
<div id="lista" class="autocomplete"></div>

<div id="info"></div>
<div id="linha-pressao" class="linha-info"></div>
<div id="linha-umidade" class="linha-info"></div>
<div id="linha-status" class="linha-status"></div>
<div id="linha-aviso" class="linha-info"></div>

<div id="linha-sol"></div>
<div id="previsao-5dias"></div>
</div>

<div class="card">
<canvas id="grafico"></canvas>
</div>

<script>
let lat=null,lon=null,chart=null;

const cidade=document.getElementById("cidade"),
lista=document.getElementById("lista"),
nomeCidade=document.getElementById("nome-cidade"),
info=document.getElementById("info"),
linhaPressao=document.getElementById("linha-pressao"),
linhaUmidade=document.getElementById("linha-umidade"),
linhaStatus=document.getElementById("linha-status"),
linhaAviso=document.getElementById("linha-aviso"),
linhaSol=document.getElementById("linha-sol"),
previsao5=document.getElementById("previsao-5dias");

cidade.addEventListener("focus",()=>{cidade.value="";lista.innerHTML="";});

cidade.addEventListener("input",async()=>{
 lista.innerHTML="";
 if(cidade.value.length<2) return;

 const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cidade.value)}&count=5&language=pt`);
 const d=await r.json();
 if(!d.results) return;

 d.results.forEach(c=>{
  const nomeCompleto=c.admin1?`${c.name} - ${c.admin1}`:`${c.name} - ${c.country}`;
  const div=document.createElement("div");
  div.innerText=nomeCompleto;
  div.onclick=()=>{
   cidade.value=nomeCompleto;
   nomeCidade.innerText=nomeCompleto;
   lat=c.latitude;
   lon=c.longitude;
   lista.innerHTML="";
   buscar();
  };
  lista.appendChild(div);
 });
});

async function buscar(){
 if(!lat||!lon) return;

 /* ===== DADOS ATUAIS ===== */
 const rAtual=await fetch(
  `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=apparent_temperature,relativehumidity_2m,pressure_msl,precipitation&daily=sunrise,sunset,temperature_2m_min,temperature_2m_max,precipitation_probability_max,precipitation_sum&timezone=auto`
 );
 const atual=await rAtual.json();

 const agora=Date.now();
 let idx=0,min=Infinity;
 atual.hourly.time.forEach((t,i)=>{
  const d=Math.abs(new Date(t).getTime()-agora);
  if(d<min){min=d;idx=i;}
 });

 info.innerHTML =
  `ğŸŒ¡ï¸ Temperatura atual: <b>${atual.current_weather.temperature}Â°C</b> â€¢ SensaÃ§Ã£o: <b>${atual.hourly.apparent_temperature[idx]}Â°C</b>`;

 linhaPressao.innerHTML =
  `ğŸŒ¬ï¸ PressÃ£o atmosfÃ©rica atual: <b>${atual.hourly.pressure_msl[idx]} hPa</b>`;

 linhaUmidade.innerHTML =
  `ğŸ’§ Umidade atual: <b>${atual.hourly.relativehumidity_2m[idx]}%</b> â€¢ ğŸ’¨ Vento: <b>${atual.current_weather.windspeed} km/h</b>`;

 definirStatus(atual.hourly.pressure_msl[idx],atual.hourly.precipitation[idx]);
 montarLinhaSol(atual.daily);
 montarPrevisao5Dias(atual.daily);

 /* ===== HISTÃ“RICO ===== */
 const hoje=new Date();
 const ini=new Date(); ini.setDate(hoje.getDate()-30);

 const rHist=await fetch(
  `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${ini.toISOString().split("T")[0]}&end_date=${hoje.toISOString().split("T")[0]}&hourly=pressure_msl,precipitation&timezone=auto`
 );
 const hist=await rHist.json();

 calcularPressaoChuva(hist.hourly);
 montarGrafico(hist.hourly);
}

function definirStatus(p,c){
 linhaStatus.className="linha-status";
 if(c>8||p<1005){linhaStatus.classList.add("tempestade");linhaStatus.innerText="â›ˆï¸ Risco de tempestade";}
 else if(c>1||p<1012){linhaStatus.classList.add("chuva");linhaStatus.innerText="ğŸŒ§ï¸ Possibilidade de chuva";}
 else{linhaStatus.classList.add("bom");linhaStatus.innerText="â˜€ï¸ Tempo bom";}
}

function calcularPressaoChuva(h){
 let p=[];
 h.precipitation.forEach((v,i)=>{if(v>=0.3)p.push(h.pressure_msl[i]);});
 if(p.length<5){
  linhaAviso.innerHTML="ğŸŒ§ï¸ <b>Nesta cidade costuma chover</b> quando a pressÃ£o estÃ¡ abaixo de <b>1013 hPa</b>.";
  return;
 }
 p.sort((a,b)=>a-b);
 const m=p.slice(0,Math.floor(p.length/2)).reduce((a,b)=>a+b)/Math.floor(p.length/2);
 linhaAviso.innerHTML=`ğŸŒ§ï¸ <b>Nesta cidade costuma chover</b> quando a pressÃ£o estÃ¡ abaixo de <b>${m.toFixed(1)} hPa</b>.`;
}

function montarLinhaSol(d){
 linhaSol.innerHTML="";
 for(let i=0;i<4;i++){
  linhaSol.innerHTML+=`
   <div class="sol-dia">
    <div class="sol-data">${d.time[i].split("-").reverse().join("/")}</div>
    ğŸŒ… ${d.sunrise[i].slice(11,16)}<br>
    ğŸŒ‡ ${d.sunset[i].slice(11,16)}
   </div>`;
 }
}

function montarPrevisao5Dias(d){
 previsao5.innerHTML="";
 for(let i=0;i<5;i++){
  const ic=d.precipitation_sum[i]>5?"ğŸŒ§ï¸":d.precipitation_sum[i]>0?"â›…":"â˜€ï¸";
  previsao5.innerHTML+=`
   <div class="previsao-dia">
    ${d.time[i].split("-").reverse().join("/")}<br>
    <div class="icon">${ic} ${d.precipitation_probability_max[i]}%</div>
    <b>${d.temperature_2m_min[i]}Â°C / ${d.temperature_2m_max[i]}Â°C</b>
   </div>`;
 }
}

function montarGrafico(h){
 const dias={},chuva={};

 h.time.forEach((t,i)=>{
  const d=t.split("T")[0];
  if(!dias[d]){dias[d]=[];chuva[d]=0;}
  dias[d].push(h.pressure_msl[i]);
  chuva[d]+=h.precipitation[i];
 });

 const labels=[],pressao=[],barras=[];
 Object.keys(dias).slice(-5).forEach(d=>{
  labels.push(d.split("-").reverse().join("/"));
  pressao.push((dias[d].reduce((a,b)=>a+b)/dias[d].length).toFixed(1));
  barras.push(chuva[d]>1?1050:null);
 });

 if(chart) chart.destroy();
 chart=new Chart(document.getElementById("grafico"),{
  data:{
   labels,
   datasets:[
    {type:"bar",label:"Dias de chuva",data:barras,backgroundColor:"rgba(255,0,0,0.18)"},
    {type:"line",label:"PressÃ£o atmosfÃ©rica (hPa)",data:pressao,borderColor:"#1565c0",borderWidth:3,tension:0.4}
   ]
  },
  options:{plugins:{title:{display:true,text:"Dias de chuva e PressÃ£o atmosfÃ©rica â€“ Ãºltimos 5 dias"}}}
 });
}

window.addEventListener("load",()=>{
 navigator.geolocation?.getCurrentPosition(p=>{
  lat=p.coords.latitude;
  lon=p.coords.longitude;
  nomeCidade.innerText="Sua localizaÃ§Ã£o";
  buscar();
 });
});
</script>
</body>
</html>
