<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & Press√£o Atmosf√©rica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(135deg,#1565c0,#26c6da);
  color:#fff;
  padding:16px;
}
h2{text-align:center}

.card{
  background:rgba(255,255,255,.18);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}

input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-size:16px;
}

button{
  background:#00e676;
  font-weight:bold;
  cursor:pointer;
}

.autocomplete{
  background:#fff;
  color:#000;
  border-radius:10px;
  margin-top:4px;
  overflow:hidden;
}
.autocomplete div{
  padding:10px;
  cursor:pointer;
}
.autocomplete div:hover{
  background:#e0e0e0;
}

.alerta{
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  font-weight:bold;
}

.alerta.verde{background:#2e7d32;}
.alerta.amarelo{background:#f9a825;color:#000;}
.alerta.vermelho{background:#c62828;}

canvas{
  background:#fff;
  border-radius:10px;
  padding:8px;
}
</style>
</head>

<body>

<h2 id="titulo">üå¶Ô∏è Clima & Press√£o Atmosf√©rica</h2>

<div class="card">
  <input id="cidade" placeholder="Digite a cidade (ex: Chapec√≥)">
  <div id="lista" class="autocomplete"></div>

  <button onclick="buscar()">Consultar √∫ltimos 7 dias</button>

  <div id="info"></div>
  <div id="previsao"></div>
  <div id="historico"></div>
  <div id="padrao"></div>
  <div id="probChuva"></div>
  <div id="alerta"></div>
</div>

<div class="card">
  <h3>üìä Press√£o atmosf√©rica ‚Äì √∫ltimos 7 dias</h3>
  <canvas id="grafico"></canvas>
</div>

<script>
let lat=null, lon=null;
let chart=null;
let chuvaGlobal=[];

const cidadeInput=document.getElementById("cidade");
const lista=document.getElementById("lista");
const info=document.getElementById("info");
const previsao=document.getElementById("previsao");
const historico=document.getElementById("historico");
const padrao=document.getElementById("padrao");
const probChuva=document.getElementById("probChuva");
const alertaDiv=document.getElementById("alerta");

/* üîç AUTOCOMPLETE */
cidadeInput.addEventListener("input", async ()=>{
  lista.innerHTML="";
  if(cidadeInput.value.length<3) return;

  const url=
    "https://geocoding-api.open-meteo.com/v1/search?name="
    +encodeURIComponent(cidadeInput.value)
    +"&count=5&language=pt";

  const r=await fetch(url);
  const d=await r.json();
  if(!d.results) return;

  d.results.forEach(c=>{
    const div=document.createElement("div");
    div.textContent=c.name+(c.admin1?" - "+c.admin1:"");
    div.onclick=()=>{
      lat=c.latitude;
      lon=c.longitude;
      cidadeInput.value=c.name;
      lista.innerHTML="";
      document.getElementById("titulo").innerText="üå¶Ô∏è Clima ‚Ä¢ "+c.name;
    };
    lista.appendChild(div);
  });
});

/* üå¶Ô∏è BUSCAR */
async function buscar(){
  if(lat===null){
    alert("Selecione a cidade na lista");
    return;
  }

  const hoje=new Date();
  const inicio=new Date();
  inicio.setDate(hoje.getDate()-7);

  const url=
    "https://archive-api.open-meteo.com/v1/archive"
    +"?latitude="+lat
    +"&longitude="+lon
    +"&start_date="+inicio.toISOString().split("T")[0]
    +"&end_date="+hoje.toISOString().split("T")[0]
    +"&hourly=pressure_msl,precipitation"
    +"&timezone=America/Sao_Paulo";

  const r=await fetch(url);
  const d=await r.json();
  if(!d.hourly){
    alert("Sem dados dispon√≠veis");
    return;
  }

  processar(d);
}

/* ‚è±Ô∏è PROCESSAR */
function processar(d){
  const dias={};

  d.hourly.time.forEach((t,i)=>{
    const dia=t.split("T")[0];
    if(!dias[dia]) dias[dia]={p:[],c:0};
    dias[dia].p.push(d.hourly.pressure_msl[i]);
    dias[dia].c+=d.hourly.precipitation[i];
  });

  const labels=[], p=[], c=[];

  Object.keys(dias).slice(-7).forEach(dia=>{
    const x=dia.split("-");
    labels.push(x[2]+"/"+x[1]+"/"+x[0]);
    p.push(dias[dia].p.reduce((a,b)=>a+b)/dias[dia].p.length);
    c.push(dias[dia].c);
  });

  chuvaGlobal=c;
  render(labels,p,c);
}

/* üìÜ PROBABILIDADE DE CHUVA */
async function buscarProbabilidadeChuva(){
  const url=
    "https://api.open-meteo.com/v1/forecast"
    +"?latitude="+lat
    +"&longitude="+lon
    +"&daily=precipitation_probability_max"
    +"&timezone=America/Sao_Paulo";

  const r=await fetch(url);
  const d=await r.json();
  if(!d.daily) return null;

  return {
    dias:d.daily.time.slice(0,5),
    prob:d.daily.precipitation_probability_max.slice(0,5)
  };
}

/* üé® FUNDO CHUVOSO */
const fundoChuvaPlugin={
  id:"fundoChuva",
  beforeDraw(chart){
    const {ctx,chartArea,scales:{x}}=chart;
    ctx.save();
    chuvaGlobal.forEach((v,i)=>{
      if(v>1){
        const w=x.width/x.ticks.length;
        const px=x.getPixelForValue(i)-w/2;
        ctx.fillStyle="rgba(255,0,0,0.08)";
        ctx.fillRect(px,chartArea.top,w,chartArea.bottom-chartArea.top);
      }
    });
    ctx.restore();
  }
};

/* üìä RENDER */
function render(labels,p,c){
  const atual=p[p.length-1];
  const media7=p.reduce((a,b)=>a+b)/p.length;

  info.innerHTML="üå¨Ô∏è Press√£o atual: <b>"+atual.toFixed(1)+" hPa</b>";
  historico.innerHTML="üìä M√©dia dos √∫ltimos 7 dias: <b>"+media7.toFixed(1)+" hPa</b>";

  let soma=0,cont=0;
  c.forEach((v,i)=>{if(v>1){soma+=p[i];cont++;}});
  const mediaChuva=cont?soma/cont:null;

  previsao.innerHTML=mediaChuva
    ? (atual<=mediaChuva
       ? "üåßÔ∏è <b>Tend√™ncia de chuva</b>"
       : "‚òÄÔ∏è <b>Baixa chance de chuva</b>")
    : "‚ÑπÔ∏è Hist√≥rico insuficiente para prever chuva";

  padrao.innerHTML=mediaChuva
    ? "üåßÔ∏è Costuma chover quando a press√£o est√° em torno de <b>"
      +mediaChuva.toFixed(1)+" hPa</b>"
    : "";

  probChuva.innerHTML="";
  buscarProbabilidadeChuva().then(res=>{
    if(!res) return;

    let html="<br>üìÜ <b>Probabilidade de chuva ‚Äì pr√≥ximos 5 dias:</b><br>";
    res.dias.forEach((d,i)=>{
      const x=d.split("-");
      html+="‚Ä¢ "+x[2]+"/"+x[1]+": <b>"+res.prob[i]+"%</b><br>";
    });
    probChuva.innerHTML=html;
  });

  alertaDiv.className="alerta";
  if(mediaChuva && (atual<=mediaChuva-2 || c.at(-1)>20)){
    alertaDiv.classList.add("vermelho");
    alertaDiv.innerText="‚ö†Ô∏è ALERTA DE TEMPESTADE ‚Äì condi√ß√µes favor√°veis!";
  }else if(atual<=media7-2){
    alertaDiv.classList.add("amarelo");
    alertaDiv.innerText="‚õàÔ∏è Aten√ß√£o: instabilidade atmosf√©rica";
  }else{
    alertaDiv.classList.add("verde");
    alertaDiv.innerText="‚úÖ Sem alerta de tempestade";
  }

  const cores=c.map(v=>v>1?"red":"#1565c0");

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("grafico"),{
    type:"line",
    data:{
      labels:labels,
      datasets:[{
        label:"Press√£o m√©dia di√°ria (hPa)",
        data:p,
        borderColor:"#1565c0",
        pointBackgroundColor:cores,
        pointRadius:6,
        borderWidth:3,
        tension:0.4
      }]
    },
    options:{
      responsive:true,
      plugins:{
        tooltip:{
          callbacks:{
            label:(ctx)=>{
              const i=ctx.dataIndex;
              return "Press√£o: "+p[i].toFixed(1)+" hPa | Chuva: "+c[i].toFixed(1)+" mm";
            }
          }
        }
      }
    },
    plugins:[fundoChuvaPlugin]
  });
}
</script>

</body>
</html>