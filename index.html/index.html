<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & Press√£o Atmosf√©rica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(135deg,#1565c0,#26c6da);
  color:#fff;
  padding:16px;
}
h2{text-align:center}

.card{
  background:rgba(255,255,255,.18);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}

input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-size:16px;
}

button{
  background:#00e676;
  font-weight:bold;
  cursor:pointer;
}

.autocomplete{
  background:#fff;
  color:#000;
  border-radius:10px;
  margin-top:4px;
  overflow:hidden;
}
.autocomplete div{
  padding:10px;
  cursor:pointer;
}
.autocomplete div:hover{background:#e0e0e0;}

.alerta{
  margin-top:10px;
  padding:10px;
  border-radius:10px;
  font-weight:bold;
}
.alerta.verde{background:#2e7d32;}
.alerta.amarelo{background:#f9a825;color:#000;}
.alerta.vermelho{background:#c62828;}

canvas{
  background:#fff;
  border-radius:10px;
  padding:8px;
}

/* ================= FUNDO ANIMADO ================= */
#weather-bg{
  position:fixed;
  inset:0;
  z-index:-1;
  pointer-events:none;
  overflow:hidden;
}

/* SOL */
.sun{
  position:absolute;
  top:40px;
  right:40px;
  width:140px;
  height:140px;
  border-radius:50%;
  background:radial-gradient(circle,#fff59d,#fbc02d);
  animation:spin 25s linear infinite;
}

/* NUVENS */
.cloud{
  position:absolute;
  top:100px;
  left:-300px;
  width:220px;
  height:65px;
  background:#fff;
  border-radius:50px;
  opacity:.75;
  animation:cloudMove 90s linear infinite;
}
.cloud::before,.cloud::after{
  content:"";
  position:absolute;
  background:#fff;
  width:90px;
  height:90px;
  border-radius:50%;
  top:-45px;
}
.cloud::before{left:25px}
.cloud::after{left:110px}

/* RAIOS */
.lightning{
  position:absolute;
  top:0;
  left:50%;
  width:4px;
  height:100vh;
  background:white;
  opacity:0;
  animation:flash 4s infinite;
}

/* ====== CHUVA ====== */
.rain{
  position:absolute;
  inset:0;
}
.drop{
  position:absolute;
  bottom:100%;
  width:2px;
  height:20px;
  background:rgba(255,255,255,.6);
  animation:rainFall linear infinite;
}

@keyframes rainFall{
  to{
    transform:translateY(110vh);
  }
}

@keyframes spin{
  from{transform:rotate(0)}
  to{transform:rotate(360deg)}
}
@keyframes cloudMove{
  from{left:-300px}
  to{left:110%}
}
@keyframes flash{
  0%,94%,100%{opacity:0}
  95%,97%{opacity:1}
}
/* ================= FIM FUNDO ================= */
</style>
</head>

<body>

<!-- CAMADA DO FUNDO -->
<div id="weather-bg"></div>

<h2 id="titulo">üå¶Ô∏è Clima & Press√£o Atmosf√©rica</h2>

<div class="card">
  <input id="cidade" placeholder="Digite a cidade (ex: Chapec√≥)">
  <div id="lista" class="autocomplete"></div>

  <button onclick="buscar()">Consultar √∫ltimos 7 dias</button>

  <div id="info"></div>
  <div id="historico"></div>
  <div id="previsao"></div>
  <div id="padrao"></div>
  <div id="probChuva"></div>
  <div id="alerta" class="alerta"></div>
</div>

<div class="card">
  <h3>üìä Press√£o atmosf√©rica ‚Äì √∫ltimos 7 dias</h3>
  <canvas id="grafico"></canvas>
</div>

<script>
let lat=null, lon=null, chart=null;
let chuvaGlobal=[], diasChuvaIndices=[];

const cidade=document.getElementById("cidade");
const lista=document.getElementById("lista");
const info=document.getElementById("info");
const historico=document.getElementById("historico");
const previsao=document.getElementById("previsao");
const padrao=document.getElementById("padrao");
const alerta=document.getElementById("alerta");
const probChuva=document.getElementById("probChuva");

/* AUTOCOMPLETE */
cidade.addEventListener("input", async ()=>{
  lista.innerHTML="";
  if(cidade.value.length<3) return;
  const r=await fetch("https://geocoding-api.open-meteo.com/v1/search?name="+cidade.value+"&count=5&language=pt");
  const d=await r.json();
  if(!d.results) return;

  d.results.forEach(c=>{
    const div=document.createElement("div");
    div.textContent=c.name+(c.admin1?" - "+c.admin1:"");
    div.onclick=()=>{
      lat=c.latitude;
      lon=c.longitude;
      cidade.value=c.name;
      document.getElementById("titulo").innerText="üå¶Ô∏è Clima ‚Ä¢ "+c.name;
      lista.innerHTML="";
    };
    lista.appendChild(div);
  });
});

/* BUSCAR */
async function buscar(){
  if(!lat){alert("Selecione a cidade");return;}
  const hoje=new Date();
  const inicio=new Date();
  inicio.setDate(hoje.getDate()-7);

  const r=await fetch(
    "https://archive-api.open-meteo.com/v1/archive"+
    "?latitude="+lat+
    "&longitude="+lon+
    "&start_date="+inicio.toISOString().split("T")[0]+
    "&end_date="+hoje.toISOString().split("T")[0]+
    "&hourly=pressure_msl,precipitation"+
    "&timezone=America/Sao_Paulo"
  );
  const d=await r.json();
  processar(d);
}

/* PROCESSAR */
function processar(d){
  const dias={};
  d.hourly.time.forEach((t,i)=>{
    const dia=t.split("T")[0];
    if(!dias[dia]) dias[dia]={p:[],c:0};
    dias[dia].p.push(d.hourly.pressure_msl[i]);
    dias[dia].c+=d.hourly.precipitation[i];
  });

  const labels=[], pressao=[], chuva=[];
  diasChuvaIndices=[];
  Object.keys(dias).slice(-7).forEach((dia,i)=>{
    labels.push(dia.split("-").reverse().join("/"));
    const media=dias[dia].p.reduce((a,b)=>a+b)/dias[dia].p.length;
    pressao.push(media);
    chuva.push(dias[dia].c);
    if(dias[dia].c>1) diasChuvaIndices.push(i);
  });

  chuvaGlobal=chuva;
  render(labels,pressao,chuva);
}

/* FUNDO GR√ÅFICO */
const fundoChuvaPlugin={
  id:"fundoChuva",
  beforeDraw(chart){
    const {ctx,chartArea,scales}=chart;
    ctx.save();
    ctx.fillStyle="rgba(30,136,229,.18)";
    diasChuvaIndices.forEach(i=>{
      const x=scales.x.getPixelForValue(i);
      const w=scales.x.getPixelForValue(i+1)-scales.x.getPixelForValue(i);
      ctx.fillRect(x-w/2,chartArea.top,w,chartArea.bottom-chartArea.top);
    });
    ctx.restore();
  }
};

/* RENDER */
async function render(labels,p,c){
  info.innerHTML="üå¨Ô∏è Press√£o atual: <b>"+p.at(-1).toFixed(1)+" hPa</b>";
  historico.innerHTML="üìä M√©dia 7 dias: <b>"+(p.reduce((a,b)=>a+b)/p.length).toFixed(1)+" hPa</b>";

  let soma=0,cont=0;
  c.forEach((v,i)=>{if(v>1){soma+=p[i];cont++;}});
  const mediaChuva=cont?soma/cont:null;

  previsao.innerHTML=mediaChuva
    ? (p.at(-1)<=mediaChuva?"üåßÔ∏è <b>Tend√™ncia de chuva</b>":"‚òÄÔ∏è <b>Baixa chance de chuva</b>")
    : "";

  padrao.innerHTML=mediaChuva
    ? "üåßÔ∏è Costuma chover quando a press√£o est√° em torno de <b>"+mediaChuva.toFixed(1)+" hPa</b>"
    : "";

  /* ALERTA */
  alerta.className="alerta";
  if(c.at(-1)>20){
    alerta.classList.add("vermelho");
    alerta.innerText="üå©Ô∏è ALERTA: Forte tempestade registrada!";
  }else if(c.at(-1)>5){
    alerta.classList.add("amarelo");
    alerta.innerText="‚õàÔ∏è Aten√ß√£o: instabilidade atmosf√©rica";
  }else{
    alerta.classList.add("verde");
    alerta.innerText="‚úÖ Sem indicativo de tempestade";
  }

  /* PROBABILIDADE FUTURA */
  const r=await fetch(
    "https://api.open-meteo.com/v1/forecast"+
    "?latitude="+lat+
    "&longitude="+lon+
    "&daily=precipitation_probability_max"+
    "&timezone=America/Sao_Paulo"
  );
  const d=await r.json();

  let html="<br>üìÜ <b>Probabilidade de chuva ‚Äì 5 dias:</b><br>";
  let maxProb=Math.max(...d.daily.precipitation_probability_max.slice(0,5));

  d.daily.time.slice(0,5).forEach((dia,i)=>{
    const p=d.daily.precipitation_probability_max[i];
    const cor=p>=70?"#e53935":p>=40?"#fbc02d":"#2e7d32";
    html+="<span style='color:"+cor+"'>‚Ä¢ "+dia.split("-").reverse().join("/")+" ‚Äì "+p+"%</span><br>";
  });
  probChuva.innerHTML=html;

  ativarFundo(maxProb);

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("grafico"),{
    type:"line",
    data:{
      labels,
      datasets:[{
        label:"Press√£o m√©dia di√°ria (hPa)",
        data:p,
        borderColor:"#1565c0",
        borderWidth:3,
        tension:.4,
        pointRadius:6,
        pointBackgroundColor:c.map(v=>v>1?"red":"#1565c0")
      }]
    },
    options:{responsive:true},
    plugins:[fundoChuvaPlugin]
  });
}

/* FUNDO + CHUVA */
function ativarFundo(prob){
  const bg=document.getElementById("weather-bg");
  bg.innerHTML="";

  if(prob>=70){
    bg.innerHTML='<div class="cloud"></div><div class="cloud" style="top:200px"></div><div class="lightning"></div>'+criarChuva(120);
  }else if(prob>=40){
    bg.innerHTML='<div class="cloud"></div><div class="cloud" style="top:180px"></div>'+criarChuva(80);
  }else{
    bg.innerHTML='<div class="sun"></div>';
  }
}

/* CRIA GOTAS */
function criarChuva(qtd){
  let html='<div class="rain">';
  for(let i=0;i<qtd;i++){
    const left=Math.random()*100;
    const dur=(Math.random()*1.5+0.7).toFixed(2);
    const delay=(Math.random()*-5).toFixed(2);
    html+=`<div class="drop" style="left:${left}%;animation-duration:${dur}s;animation-delay:${delay}s"></div>`;
  }
  html+='</div>';
  return html;
}
</script>

</body>
</html>