<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & PressÃ£o AtmosfÃ©rica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(135deg,#1565c0,#26c6da);
  color:#fff;
  padding:16px;
}
h2{text-align:center}

.card{
  background:rgba(255,255,255,.18);
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}

input,button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-size:16px;
}

button{
  background:#00e676;
  font-weight:bold;
  cursor:pointer;
}

.autocomplete{
  background:#fff;
  color:#000;
  border-radius:10px;
  margin-top:4px;
}
.autocomplete div{
  padding:10px;
  cursor:pointer;
}
.autocomplete div:hover{background:#e0e0e0;}

.alerta{
  margin-top:12px;
  padding:12px;
  border-radius:10px;
  font-weight:bold;
}
.alerta.verde{background:#2e7d32;}
.alerta.amarelo{background:#f9a825;color:#000;}
.alerta.vermelho{background:#c62828;}

.prob{
  padding:6px 10px;
  border-radius:8px;
  margin-top:6px;
  font-weight:bold;
}
.prob.verde{background:#2e7d32;}
.prob.amarelo{background:#f9a825;color:#000;}
.prob.vermelho{background:#c62828;}

canvas{
  background:#fff;
  border-radius:10px;
  padding:8px;
}
</style>
</head>

<body>

<h2 id="titulo">ğŸŒ¦ï¸ Clima & PressÃ£o AtmosfÃ©rica</h2>

<div class="card">
  <input id="cidade" placeholder="Digite a cidade (ex: ChapecÃ³)">
  <div id="lista" class="autocomplete"></div>

  <button onclick="buscar()">Consultar</button>

  <div id="info"></div>
  <div id="historico"></div>
  <div id="padrao"></div>
  <div id="probChuva"></div>
  <div id="alerta"></div>
</div>

<div class="card">
  <h3>ğŸ“Š PressÃ£o atmosfÃ©rica â€“ Ãºltimos 7 dias</h3>
  <canvas id="grafico"></canvas>
</div>

<script>
let lat=null, lon=null, chart=null;

const cidade=document.getElementById("cidade");
const lista=document.getElementById("lista");
const info=document.getElementById("info");
const historico=document.getElementById("historico");
const padrao=document.getElementById("padrao");
const probChuva=document.getElementById("probChuva");
const alerta=document.getElementById("alerta");

/* ğŸ” AUTOCOMPLETE */
cidade.addEventListener("input",async()=>{
  lista.innerHTML="";
  if(cidade.value.length<3) return;

  const r=await fetch(
    "https://geocoding-api.open-meteo.com/v1/search?name="
    +cidade.value+"&count=5&language=pt"
  );
  const d=await r.json();
  if(!d.results) return;

  d.results.forEach(c=>{
    const div=document.createElement("div");
    div.textContent=c.name+(c.admin1?" - "+c.admin1:"");
    div.onclick=()=>{
      lat=c.latitude;
      lon=c.longitude;
      cidade.value=c.name;
      lista.innerHTML="";
      titulo.innerText="ğŸŒ¦ï¸ Clima â€¢ "+c.name;
    };
    lista.appendChild(div);
  });
});

/* â–¶ï¸ BOTÃƒO */
async function buscar(){
  if(lat==null){ alert("Selecione a cidade"); return; }
  await buscarHistorico();
  await buscarProbabilidadeChuva();
}

/* ğŸ“Š HISTÃ“RICO DA PRESSÃƒO */
async function buscarHistorico(){
  const hoje=new Date();
  const ini=new Date(); ini.setDate(hoje.getDate()-7);

  const url=
    "https://archive-api.open-meteo.com/v1/archive"
    +"?latitude="+lat
    +"&longitude="+lon
    +"&start_date="+ini.toISOString().split("T")[0]
    +"&end_date="+hoje.toISOString().split("T")[0]
    +"&hourly=pressure_msl,precipitation"
    +"&timezone=America/Sao_Paulo";

  const r=await fetch(url);
  const d=await r.json();
  if(!d.hourly) return;

  const dias={}, chuvaDias={};

  d.hourly.time.forEach((t,i)=>{
    const dia=t.split("T")[0];
    if(!dias[dia]){ dias[dia]=[]; chuvaDias[dia]=0; }
    dias[dia].push(d.hourly.pressure_msl[i]);
    chuvaDias[dia]+=d.hourly.precipitation[i];
  });

  const labels=[], pressao=[], cores=[], pressaoChuva=[];

  Object.keys(dias).slice(-7).forEach(d=>{
    const x=d.split("-");
    const mediaDia=dias[d].reduce((a,b)=>a+b)/dias[d].length;

    labels.push(x[2]+"/"+x[1]);
    pressao.push(mediaDia);

    if(chuvaDias[d]>1){
      cores.push("red");          // ğŸ”´ choveu
      pressaoChuva.push(mediaDia);
    }else{
      cores.push("#1565c0");      // ğŸ”µ nÃ£o choveu
    }
  });

  const atual=pressao.at(-1);
  const media7=pressao.reduce((a,b)=>a+b)/pressao.length;
  const mediaChuva=pressaoChuva.length
    ? pressaoChuva.reduce((a,b)=>a+b)/pressaoChuva.length
    : null;

  info.innerHTML="ğŸŒ¬ï¸ PressÃ£o atual: <b>"+atual.toFixed(1)+" hPa</b>";
  historico.innerHTML="ğŸ“Š MÃ©dia dos Ãºltimos 7 dias: <b>"+media7.toFixed(1)+" hPa</b>";

  padrao.innerHTML=mediaChuva
    ? "ğŸŒ§ï¸ Costuma chover quando a pressÃ£o estÃ¡ em torno de <b>"
      +mediaChuva.toFixed(1)+" hPa</b>"
    : "â„¹ï¸ HistÃ³rico insuficiente para definir padrÃ£o de chuva";

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("grafico"),{
    type:"line",
    data:{
      labels,
      datasets:[{
        label:"PressÃ£o mÃ©dia diÃ¡ria (hPa)",
        data:pressao,
        borderColor:"#1565c0",
        borderWidth:3,
        tension:0.4,
        pointRadius:6,
        pointBackgroundColor:cores   // ğŸ¯ cores por dia
      }]
    },
    options:{responsive:true}
  });
}

/* ğŸŒ§ï¸ PROBABILIDADE + ALERTA */
async function buscarProbabilidadeChuva(){
  const r=await fetch(
    "https://api.open-meteo.com/v1/forecast?latitude="
    +lat+"&longitude="+lon
    +"&daily=precipitation_probability_max"
    +"&timezone=America/Sao_Paulo"
  );
  const d=await r.json();
  if(!d.daily) return;

  const dias=d.daily.time.slice(0,5);
  const prob=d.daily.precipitation_probability_max.slice(0,5);

  let html="<br>ğŸ“† <b>Probabilidade de chuva â€“ prÃ³ximos 5 dias:</b>";
  prob.forEach((p,i)=>{
    let cls="verde";
    if(p>=70) cls="vermelho";
    else if(p>=30) cls="amarelo";
    const x=dias[i].split("-");
    html+=`<div class="prob ${cls}">${x[2]}/${x[1]} â†’ ${p}%</div>`;
  });
  probChuva.innerHTML=html;

  const max=Math.max(...prob);
  alerta.className="alerta "+(max>=80?"vermelho":max>=60?"amarelo":"verde");
  alerta.innerText=
    max>=80?"âš ï¸ ALERTA: Alta probabilidade de TEMPESTADE":
    max>=60?"â›ˆï¸ AtenÃ§Ã£o: risco de temporal":
    "âœ… Sem indicativo de tempestade";
}
</script>

</body>
</html>