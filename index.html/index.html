<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Clima & Alertas ajp Inteligentes</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(135deg,#1565c0,#26c6da);
  color:#fff;
  padding:16px;
}
h2{text-align:center}
.card{
  background:rgba(255,255,255,.18);
  border-radius:18px;
  padding:18px;
  margin-bottom:18px;
}
button,input{
  width:100%;
  padding:12px;
  margin-top:10px;
  font-size:16px;
  border:none;
  border-radius:12px;
}
button{
  background:#00e676;
  font-weight:bold;
  cursor:pointer;
}
.resultado{
  margin-top:6px;
  font-size:18px;
}
.status{
  font-size:20px;
  font-weight:bold;
  margin-top:10px;
}
canvas{
  background:#fff;
  border-radius:12px;
  padding:10px;
}
</style>
</head>

<body>

<h2>ğŸŒ¦ï¸ Clima & Alertas Inteligentes</h2>

<div class="card">
  <button onclick="usarGPS()">ğŸ“ Usar minha localizaÃ§Ã£o</button>
  <div class="resultado" id="local"></div>

  <input type="date" id="data">
  <button onclick="buscar()">Consultar</button>

  <div class="resultado" id="pressao"></div>
  <div class="resultado" id="chuva"></div>
  <div class="resultado" id="variacao"></div>
  <div class="resultado" id="comparacao"></div>
  <div class="status" id="status"></div>
</div>

<div class="card">
  <h3>ğŸ“Š PressÃ£o â€“ histÃ³rico (30 dias)</h3>
  <canvas id="grafico"></canvas>
</div>

<script>
/* ==========================
   VARIÃVEIS GLOBAIS
========================== */
let lat = -27.1;
let lon = -52.6;
let chart;

/* ==========================
   ELEMENTOS DOM
========================== */
const dataInput = document.getElementById("data");
const pressaoDiv = document.getElementById("pressao");
const chuvaDiv = document.getElementById("chuva");
const variacaoDiv = document.getElementById("variacao");
const comparacaoDiv = document.getElementById("comparacao");
const statusDiv = document.getElementById("status");
const localDiv = document.getElementById("local");
const grafico = document.getElementById("grafico");

/* ==========================
   GEOCODIFICAÃ‡ÃƒO REVERSA
========================== */
async function buscarCidadeEstado(lat, lon){
  try{
    const r1 = await fetch(
      `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=pt`
    );
    const j1 = await r1.json();

    if(j1.results && j1.results.length){
      return `${j1.results[0].name} â€“ ${j1.results[0].admin1}`;
    }
  }catch(e){}

  try{
    const r2 = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=pt-BR`
    );
    const j2 = await r2.json();

    if(j2.address){
      return `${j2.address.city || j2.address.town || j2.address.village || "Cidade"} â€“ ${j2.address.state || ""}`;
    }
  }catch(e){}

  return "Local nÃ£o identificado";
}

/* ==========================
   GPS
========================== */
function usarGPS(){
  if(!navigator.geolocation){
    alert("âŒ GPS nÃ£o suportado");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async pos=>{
      lat = pos.coords.latitude;
      lon = pos.coords.longitude;

      localDiv.innerHTML = "ğŸ” Identificando local...";
      const local = await buscarCidadeEstado(lat, lon);

      localDiv.innerHTML =
        `ğŸ“ <b>${local}</b><br>ğŸŒ Lat: ${lat.toFixed(4)} | Lon: ${lon.toFixed(4)}`;
    },
    err=>{
      alert("âŒ Erro no GPS: " + err.message);
    },
    { enableHighAccuracy:true, timeout:10000 }
  );
}

/* ==========================
   BUSCAR DADOS CLIMÃTICOS
========================== */
async function buscar(){
  if(!dataInput.value){
    alert("ğŸ“… Selecione uma data");
    return;
  }

  let fim = new Date(dataInput.value);
  const hoje = new Date();

  // âš ï¸ Open-Meteo nÃ£o entrega dia atual
  if(fim.toDateString() === hoje.toDateString()){
    fim.setDate(fim.getDate() - 1);
  }

  if(fim > hoje){
    alert("âš ï¸ Data futura nÃ£o permitida");
    return;
  }

  const inicio = new Date(fim);
  inicio.setDate(inicio.getDate() - 30);

  const url =
    `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${inicio.toISOString().split("T")[0]}&end_date=${fim.toISOString().split("T")[0]}&daily=pressure_msl,precipitation_sum&timezone=America/Sao_Paulo`;

  try{
    const r = await fetch(url);
    const d = await r.json();

    if(!d.daily || !d.daily.pressure_msl || d.daily.pressure_msl.length === 0){
      alert("âŒ Sem dados disponÃ­veis para esta data.");
      return;
    }

    const pHoje = d.daily.pressure_msl.at(-1);
    const pSemana = d.daily.pressure_msl.slice(-7).reduce((a,b)=>a+b)/7;
    const pMes = d.daily.pressure_msl.reduce((a,b)=>a+b)/d.daily.pressure_msl.length;
    const chuvaHoje = d.daily.precipitation_sum.at(-1);

    pressaoDiv.innerHTML = `ğŸŒ¬ï¸ PressÃ£o: <b>${pHoje.toFixed(1)} hPa</b>`;
    comparacaoDiv.innerHTML =
      `ğŸ“Š MÃ©dia 7 dias: ${pSemana.toFixed(1)} hPa<br>ğŸ“ˆ MÃ©dia mÃªs: ${pMes.toFixed(1)} hPa`;
    variacaoDiv.innerHTML =
      `ğŸ”„ DiferenÃ§a hoje/semana: ${(pHoje-pSemana).toFixed(1)} hPa`;
    chuvaDiv.innerHTML =
      chuvaHoje > 0 ? `ğŸŒ§ï¸ Chuva: ${chuvaHoje} mm` : "â˜€ï¸ Sem chuva";

    let indice = "ğŸŸ¢ Baixo";
    if(pHoje < 1010) indice = "ğŸŸ¡ Moderado";
    if(pHoje < 1007 || chuvaHoje > 20) indice = "ğŸ”´ Alto";

    statusDiv.innerText = `ğŸŒªï¸ Ãndice de tempestade: ${indice}`;

    if(chart) chart.destroy();
    chart = new Chart(grafico,{
      type:"line",
      data:{
        labels:d.daily.time,
        datasets:[{
          label:"PressÃ£o (hPa)",
          data:d.daily.pressure_msl,
          borderWidth:3,
          tension:0.4
        }]
      }
    });

  }catch(e){
    alert("âŒ Erro ao consultar dados");
    console.error(e);
  }
}

/* ==========================
   BLOQUEIA DATA FUTURA
========================== */
dataInput.max = new Date().toISOString().split("T")[0];
</script>

</body>
</html>